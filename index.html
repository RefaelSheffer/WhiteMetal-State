<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SLV Monitor</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background: #0b0f17; color: #e8eefc; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #111a2b; border: 1px solid #1e2a45; border-radius: 14px; padding: 16px; }
    .big { font-size: 28px; font-weight: 800; }
    .muted { color: #a8b4d6; }
    .alert { margin-top: 10px; background: rgba(255, 159, 64, 0.12); border: 1px solid #ff9f40; color: #ffd7a2; padding: 10px 12px; border-radius: 10px; line-height: 1.5; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .kpis.four { grid-template-columns: repeat(4, 1fr); }
    .kpi { background:#0d1424; border:1px solid #1e2a45; border-radius:12px; padding:10px; }
    .kpi .v { font-size: 18px; font-weight: 700; margin-top: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .cycle-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    .cycle-table th, .cycle-table td { padding: 6px 8px; text-align: right; border-bottom: 1px solid #1e2a45; }
    .cycle-table th { color: #a8b4d6; font-weight: 600; }
    .cycle-table td { color: #e8eefc; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #1e2a45; }
    .pill.up { background: rgba(34, 197, 94, 0.12); color: #22c55e; }
    .pill.down { background: rgba(244, 63, 94, 0.12); color: #f43f5e; }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    a { color:#8bb2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="big">SLV Monitor</div>
      <div class="muted">דשבורד סטטי ב-GitHub Pages + “מוח” שרץ ב-GitHub Actions ומעדכן JSON.</div>
      <div class="muted mono" id="updated">Loading…</div>
      <div class="alert">
        המלצות המערכת הן תוצאה של עיבוד סטטיסטי ואינן מהוות ייעוץ או הנחיה לביצוע פעולה מיידית. מומלץ לשלב את האיתותים עם
        גורמים נוספים כמו חדשות מאקרו, מדיניות מוניטרית ושיקולים אישיים אחרים.
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="big" id="action">—</div>
        <div class="muted">Confidence: <span class="mono" id="confidence">—</span></div>

        <div class="kpis">
          <div class="kpi">
            <div class="muted">Score Total</div>
            <div class="v mono" id="scoreTotal">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Price Score</div>
            <div class="v mono" id="scorePrice">—</div>
          </div>
          <div class="kpi">
            <div class="muted">COT Score</div>
            <div class="v mono" id="scoreCOT">—</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="muted">Latest Close: <span class="mono" id="lastClose">—</span></div>
        <div class="muted">MA20/50/200: <span class="mono" id="mas">—</span></div>
        <div class="muted">1M Mom%: <span class="mono" id="mom">—</span></div>

        <div style="height:12px"></div>
        <div class="muted">COT (Silver): <span class="mono" id="cotLine">—</span></div>
        <div class="muted">EDGAR: <span class="mono" id="edgarLine">—</span></div>
      </div>

      <div class="card">
        <div class="big">Price</div>
        <div id="chart" style="height:420px;"></div>
        <div class="muted" style="margin-top:8px;">מחזורי Peaks/Troughs אחרונים</div>
        <table class="cycle-table" id="cycleTable">
          <thead>
            <tr>
              <th>תאריך סיום</th>
              <th>תאריך התחלה</th>
              <th>כיוון</th>
              <th>אורך</th>
              <th>אמפליטודה</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="big">ציון ביצועים כולל</div>
        <div class="muted">עודכן: <span class="mono" id="perfSummaryUpdated">—</span></div>

        <div class="kpis four">
          <div class="kpi">
            <div class="muted">Hit Rate</div>
            <div class="v mono" id="hitRate">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Avg Return 5d</div>
            <div class="v mono" id="avgReturn5d">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Avg Return 10d</div>
            <div class="v mono" id="avgReturn10d">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Max Drawdown</div>
            <div class="v mono" id="maxDrawdown">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="big">Equity vs Benchmark (SLV)</div>
        <div id="perfChart" style="height:320px;"></div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="big">Performance</div>
        <div class="muted">RSI (14): <span class="mono" id="rsiValue">—</span></div>
        <div class="muted">Rolling StdDev (20): <span class="mono" id="stddevValue">—</span></div>
        <div class="muted">Perf Updated: <span class="mono" id="perfUpdated">—</span></div>
      </div>

      <div class="card">
        <div class="big">Decomposition</div>
        <div class="muted">Updated: <span class="mono" id="decompUpdated">—</span></div>
        <div class="muted">Period: <span class="mono" id="decompPeriod">—</span></div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="big">Trend</div>
        <div id="trendChart" style="height:320px;"></div>
      </div>

      <div class="card">
        <div class="big">Seasonal / Residual</div>
        <div id="seasonalChart" style="height:320px;"></div>
      </div>
    </div>
  </div>

<script>
async function getJson(path) {
  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) throw new Error(`Failed ${path}: ${r.status}`);
  return await r.json();
}

function fmt(x, d=2) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return Number(x).toFixed(d);
}

function fmtPct(x, d=1) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return `${(Number(x) * 100).toFixed(d)}%`;
}

(async () => {
  const [prices, signal, cot, edgar, rsiPerf, stddevPerf, decomposition, perfSummary, equityCurve, cycleStats] = await Promise.all([
    getJson("./data/slv_prices.json"),
    getJson("./data/signal_latest.json"),
    getJson("./data/cot_silver.json"),
    getJson("./data/edgar_latest.json"),
    getJson("./public/data/perf/rsi.json"),
    getJson("./public/data/perf/stddev.json"),
    getJson("./public/data/perf/decomposition.json"),
    getJson("./public/data/perf/summary.json"),
    getJson("./public/data/perf/equity_curve.json"),
    getJson("./public/data/events/cycle_stats.json"),
  ]);

  document.getElementById("updated").textContent =
    `Updated (UTC): ${signal.updated_at_utc}`;

  document.getElementById("action").textContent = signal.action;
  document.getElementById("confidence").textContent = signal.confidence;

  document.getElementById("scoreTotal").textContent = fmt(signal.score_total, 0);
  document.getElementById("scorePrice").textContent = fmt(signal.breakdown.score_price, 0);
  document.getElementById("scoreCOT").textContent = fmt(signal.breakdown.score_cot, 0);

  document.getElementById("lastClose").textContent = fmt(signal.price.last_close, 2);
  document.getElementById("mas").textContent =
    `${fmt(signal.price.ma20,2)} / ${fmt(signal.price.ma50,2)} / ${fmt(signal.price.ma200,2)}`;
  document.getElementById("mom").textContent = fmt(signal.price.mom_1m_pct, 2);

  if (cot.cot_available) {
    document.getElementById("cotLine").textContent =
      `Report ${cot.cot_report_date}, nc_net=${fmt(cot.nc_net,0)}, Δ4w=${fmt(cot.nc_net_delta_4w,0)}, pct=${fmt(cot.nc_net_percentile,1)}`;
  } else {
    document.getElementById("cotLine").textContent = "COT unavailable (yet).";
  }

  if (edgar.edgar_available && edgar.latest_filing) {
    document.getElementById("edgarLine").textContent =
      `${edgar.latest_filing.form} @ ${edgar.latest_filing.filingDate} (days_ago=${edgar.latest_filing.days_ago})`;
  } else if (edgar.edgar_available) {
    document.getElementById("edgarLine").textContent = "No latest filing found.";
  } else {
    document.getElementById("edgarLine").textContent = "EDGAR unavailable (yet).";
  }

  const latestRsi = rsiPerf.rsi?.[rsiPerf.rsi.length - 1];
  const latestStd = stddevPerf.stddev?.[stddevPerf.stddev.length - 1];
  document.getElementById("rsiValue").textContent = fmt(latestRsi?.rsi, 2);
  document.getElementById("stddevValue").textContent = fmt(latestStd?.stddev, 4);
  document.getElementById("perfUpdated").textContent = rsiPerf.updated_at || "—";

  document.getElementById("perfSummaryUpdated").textContent = perfSummary.updated_at || "—";
  document.getElementById("hitRate").textContent = fmtPct(perfSummary.hit_rate, 0);
  document.getElementById("avgReturn5d").textContent = fmtPct(perfSummary.avg_return_5d, 2);
  document.getElementById("avgReturn10d").textContent = fmtPct(perfSummary.avg_return_10d, 2);
  document.getElementById("maxDrawdown").textContent = fmtPct(perfSummary.max_drawdown, 2);

  document.getElementById("decompUpdated").textContent = decomposition.updated_at || "—";
  document.getElementById("decompPeriod").textContent = decomposition.period ?? "—";

  // Chart
  const trace = {
    x: prices.dates,
    y: prices.close,
    type: "scatter",
    mode: "lines",
    name: "SLV Close",
  };

  const turningPoints = cycleStats?.turning_points ?? [];
  const peakPoints = turningPoints.filter((p) => p.kind === "peak");
  const troughPoints = turningPoints.filter((p) => p.kind === "trough");

  const peakTrace = {
    x: peakPoints.map((p) => p.date),
    y: peakPoints.map((p) => p.close),
    mode: "markers",
    type: "scatter",
    name: "Peak",
    marker: { color: "#f43f5e", size: 8, symbol: "triangle-up" },
  };

  const troughTrace = {
    x: troughPoints.map((p) => p.date),
    y: troughPoints.map((p) => p.close),
    mode: "markers",
    type: "scatter",
    name: "Trough",
    marker: { color: "#22c55e", size: 8, symbol: "triangle-down" },
  };

  const layout = {
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    margin: { l: 45, r: 15, t: 20, b: 40 },
    xaxis: { showgrid: false, color: "#a8b4d6" },
    yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6" },
  };

  const priceSeries = [trace];
  if (turningPoints.length) {
    priceSeries.push(peakTrace, troughTrace);
  }

  Plotly.newPlot("chart", priceSeries, layout, {displayModeBar: false});

  const cyclesData = cycleStats?.cycles ?? [];
  const tableBody = document.querySelector("#cycleTable tbody");
  const recentCycles = cyclesData.slice(-6).reverse();

  if (tableBody) {
    if (recentCycles.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" class="muted">No cycles detected yet.</td></tr>';
    } else {
      tableBody.innerHTML = recentCycles
        .map((cycle) => {
          const amp = fmtPct(cycle.amplitude, 1);
          const len = cycle.length ?? 0;
          const dir = cycle.direction === "upswing" ? "up" : "down";
          return `
            <tr>
              <td>${cycle.end_date}</td>
              <td>${cycle.start_date}</td>
              <td><span class="pill ${dir}">${cycle.direction}</span></td>
              <td>${len}d</td>
              <td>${amp}</td>
            </tr>
          `;
        })
        .join("");
    }
  }

  const equitySeries = equityCurve.equity_curve ?? [];
  if (equitySeries.length) {
    const eqValues = equitySeries.map((p) => p.equity);
    const eqBase = eqValues[0] || 1;
    const eqNormalized = eqValues.map((v) => v / eqBase);
    const sliceLen = eqNormalized.length;
    const benchPrices = prices.close.slice(-sliceLen);
    const benchDates = prices.dates.slice(-sliceLen);

    if (benchPrices.length === sliceLen && benchDates.length === sliceLen) {
      const benchBase = benchPrices[0] || 1;
      const benchNormalized = benchPrices.map((p) => p / benchBase);

      const equityTrace = {
        x: benchDates,
        y: eqNormalized,
        type: "scatter",
        mode: "lines",
        name: "Algo Equity",
        line: { color: "#60a5fa" },
      };

      const benchTrace = {
        x: benchDates,
        y: benchNormalized,
        type: "scatter",
        mode: "lines",
        name: "SLV Benchmark",
        line: { color: "#22c55e" },
      };

      Plotly.newPlot(
        "perfChart",
        [equityTrace, benchTrace],
        { ...layout, yaxis: { ...layout.yaxis, title: "Normalized Performance" } },
        { displayModeBar: false }
      );
    } else {
      document.getElementById("perfChart").textContent = "Benchmark window unavailable.";
    }
  } else {
    document.getElementById("perfChart").textContent = "Performance series unavailable.";
  }

  if (decomposition.trend?.length) {
    const trendTrace = {
      x: prices.dates,
      y: decomposition.trend.map((p) => p.trend),
      type: "scatter",
      mode: "lines",
      name: "Trend",
      line: { color: "#4c9cff" },
    };

    Plotly.newPlot(
      "trendChart",
      [trendTrace],
      { ...layout, yaxis: { ...layout.yaxis, title: "Trend" } },
      { displayModeBar: false }
    );
  } else {
    document.getElementById("trendChart").textContent = "Decomposition unavailable.";
  }

  if (decomposition.seasonal?.length || decomposition.resid?.length) {
    const seasonalTrace = {
      x: prices.dates,
      y: decomposition.seasonal?.map((p) => p.seasonal) ?? [],
      type: "scatter",
      mode: "lines",
      name: "Seasonal",
      line: { color: "#22c55e" },
    };

    const residTrace = {
      x: prices.dates,
      y: decomposition.resid?.map((p) => p.resid) ?? [],
      type: "scatter",
      mode: "lines",
      name: "Residual",
      line: { color: "#fbbf24" },
    };

    Plotly.newPlot(
      "seasonalChart",
      [seasonalTrace, residTrace],
      { ...layout, yaxis: { ...layout.yaxis, title: "Seasonal / Residual" } },
      { displayModeBar: false }
    );
  } else {
    document.getElementById("seasonalChart").textContent = "Decomposition unavailable.";
  }
})();
</script>
</body>
</html>
