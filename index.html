<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SLV Monitor</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {
      --bg: #0b0f17;
      --card: #111a2b;
      --border: #1e2a45;
      --muted: #a8b4d6;
      --text: #e8eefc;
      --accent: #4c9cff;
      --success: #22c55e;
      --danger: #f43f5e;
    }
    body { font-family: system-ui, Arial; margin: 0; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; }
    .big { font-size: 28px; font-weight: 800; }
    .muted { color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .alert { margin-top: 10px; background: rgba(255, 159, 64, 0.12); border: 1px solid #ff9f40; color: #ffd7a2; padding: 10px 12px; border-radius: 10px; line-height: 1.5; }
    .alert-card { margin-top: 10px; background: #0d1424; border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; }
    .alert-card .title { font-weight: 700; }
    .badge-inline { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-inline-end: 6px; border: 1px solid var(--border); }
    .sev-info { background: rgba(76, 156, 255, 0.15); color: #8bb2ff; }
    .sev-warn { background: rgba(255, 159, 64, 0.18); color: #ffb86c; }
    .sev-critical { background: rgba(244, 63, 94, 0.2); color: #f43f5e; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 12px; }
    .kpi { background: #0d1424; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .kpi .v { font-size: 18px; font-weight: 700; margin-top: 4px; }
    .kpi .small { font-size: 12px; color: var(--muted); margin-top: 4px; display: block; line-height: 1.4; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 13px; border: 1px solid var(--border); text-transform: uppercase; letter-spacing: 0.5px; }
    .pill.up { background: rgba(34, 197, 94, 0.12); color: var(--success); }
    .pill.down { background: rgba(244, 63, 94, 0.12); color: var(--danger); }
    .pill.neutral { background: rgba(255,255,255,0.06); color: var(--text); }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin: 12px 0 8px; }
    .btn { background: #0d1424; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 6px 10px; cursor: pointer; }
    .btn.active { background: #1f2d4a; border-color: var(--accent); }
    .toggle { display: inline-flex; gap: 6px; align-items: center; padding: 6px 10px; background: #0d1424; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; }
    .toggle input { accent-color: var(--accent); }
    .header-top { display: flex; justify-content: space-between; gap: 12px; }
    .header-content { flex: 1; min-width: 0; }
    .meta-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 8px; background: rgba(255,255,255,0.06); font-size: 12px; margin-right: 6px; }
    .badge.soft { background: rgba(99, 102, 241, 0.12); color: #c7d2fe; border: 1px solid var(--border); }
    .section-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .chip { padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; }
    .chip.muted { background: rgba(255,255,255,0.06); color: var(--muted); }
    .chip.info { background: rgba(76, 156, 255, 0.15); color: #8bb2ff; }
    .table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    .table th, .table td { padding: 8px; text-align: right; border-bottom: 1px solid var(--border); }
    .table th { color: var(--muted); font-weight: 700; }
    .table td { color: var(--text); }
    body[dir="ltr"] .table th, body[dir="ltr"] .table td { text-align: left; }
    .flex { display: flex; align-items: center; gap: 8px; }
    .space { flex: 1; }
    .settings { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 12px; margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    label.small { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select { width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: #0d1424; color: var(--text); }
    .subtitle { font-size: 14px; color: var(--muted); margin-top: 4px; }
    .cost-impact { margin-top: 10px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 12px; padding: 10px; color: var(--muted); font-size: 13px; line-height: 1.5; }
    .cost-impact strong { color: var(--text); }
    .state-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-inline-end: 6px; }
    .dot-bull { background: var(--success); }
    .dot-bear { background: var(--danger); }
    .dot-neutral { background: #a8b4d6; }
    .evidence-list { margin: 10px 0 0; padding: 0 0 0 18px; color: var(--muted); line-height: 1.6; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
    .range-chip { background: rgba(255,255,255,0.06); padding: 6px 10px; border-radius: 10px; display: inline-flex; gap: 8px; align-items: center; }
    .analogy { background: #0d1424; border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 8px; }
    .panel-label { font-size: 13px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--muted); }
    .mini-bar { position: relative; height: 40px; margin-top: 12px; background: #0d1424; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .mini-track { position: absolute; top: 50%; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #1d4ed8, #60a5fa, #6b7280, #fb923c, #ef4444); transform: translateY(-50%); opacity: 0.8; }
    .mini-pointer { position: absolute; top: 6px; width: 2px; height: 28px; background: #fff; border-radius: 2px; box-shadow: 0 0 6px rgba(255,255,255,0.6); transition: left 0.2s ease; }
    .mini-label { position: absolute; top: 6px; font-size: 11px; color: var(--muted); padding: 2px 6px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; }
    .mini-label.left { left: 6px; }
    .mini-label.right { right: 6px; }
    .band-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-top: 12px; }
    .band-card { background: #0d1424; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .band-card .title { font-weight: 700; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .band-card .stat { font-size: 14px; line-height: 1.5; color: var(--muted); }
    .pill.extreme-high { background: rgba(239, 68, 68, 0.16); color: #f87171; }
    .pill.high { background: rgba(248, 180, 0, 0.16); color: #fbbf24; }
    .pill.neutral { background: rgba(255,255,255,0.08); color: var(--text); }
    .pill.low { background: rgba(96, 165, 250, 0.18); color: #93c5fd; }
    .pill.extreme-low { background: rgba(37, 99, 235, 0.18); color: #bfdbfe; }
    .heatmap-legend { display: flex; gap: 8px; align-items: center; margin-top: 8px; color: var(--muted); font-size: 12px; flex-wrap: wrap; }
    .legend-swatch { width: 14px; height: 14px; border-radius: 4px; display: inline-block; border: 1px solid var(--border); }
    .context-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-top: 10px; }
    .context-item-card { background: #0d1424; border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .context-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
    .context-name { font-weight: 700; }
    .stat-block { flex: 1; min-width: 120px; }
    .stat-label { font-size: 12px; color: var(--muted); }
    .stat-value { font-size: 16px; font-family: monospace; }
    .stat-pair { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; width: 100%; }
    .context-low-confidence { opacity: 0.82; }
    .context-note { color: var(--muted); font-size: 13px; line-height: 1.5; margin-top: 6px; }
    .context-warning { color: #fbbf24; font-size: 12px; }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    a { color: #8bb2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header-top">
        <div class="header-content">
          <div class="big" data-i18n="title">SLV Monitor</div>
          <div class="muted" data-i18n="subtitle">דשבורד סטטי ב-GitHub Pages + “מוח” שרץ ב-GitHub Actions ומעדכן JSON.</div>
          <div class="muted mono" id="updated">Loading…</div>
          <div class="meta-row">
            <span class="badge"><span data-i18n="metaSourceLabel">Data source</span>: <span class="mono" id="metaSource">—</span></span>
            <span class="badge"><span data-i18n="metaCoverageLabel">Coverage</span>: <span class="mono" id="metaCoverage">—</span></span>
            <span class="badge"><span data-i18n="metaUpdatedLabel">Last updated</span>: <span class="mono" id="metaUpdated">—</span></span>
            <span class="badge soft" id="eventContextBadge">—</span>
          </div>
        </div>
        <button class="btn" id="langToggle" aria-label="Switch language">English</button>
      </div>
      <div class="alert" data-i18n="alert">
        המלצות המערכת הן תוצאה של עיבוד סטטיסטי ואינן מהוות ייעוץ או הנחיה לביצוע פעולה מיידית. מומלץ לשלב את האיתותים עם גורמים נוספים כמו חדשות מאקרו, מדיניות מוניטרית ושיקולים אישיים אחרים.
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card" id="snapshotCard">
        <div class="section-title flex">
          <span data-i18n="marketSnapshotTitle">Market Snapshot</span>
          <span class="pill neutral" id="biasBadge">—</span>
          <span class="pill neutral" id="volBadge">—</span>
        </div>
          <div class="muted" id="scenarioId">—</div>
          <div class="big" id="probHeadline">—</div>
          <div class="subtitle" id="probSubtext">—</div>
        <div class="kpis">
          <div class="kpi">
            <div class="muted" data-i18n="confidenceLabel">Confidence</div>
            <div class="v mono" id="probConfidence">—</div>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="occurrencesLabel">Occurrences</div>
            <div class="v mono" id="probOccurrences">—</div>
            <span class="small" id="probDisclaimer">—</span>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="historicalRangeLabel">Common range (5d)</div>
            <div class="v mono" id="probRange">—</div>
            <span class="small" id="probMedian">—</span>
          </div>
        </div>
        <div class="muted" id="historicalSentence">—</div>
        <ul class="evidence-list" id="probEvidence"></ul>
      </div>

      <div class="card" id="outcomesCard">
        <div class="section-title" data-i18n="whatItMeansTitle">What this usually means</div>
        <div class="kpis">
          <div class="kpi">
            <div class="muted">P(up 5d)</div>
            <div class="v mono" id="probUp">—</div>
            <span class="small" data-i18n="limitsCopy">הנתונים היסטוריים בלבד; לא התחייבות לתוצאה.</span>
          </div>
          <div class="kpi">
            <div class="muted">P(down 5d)</div>
            <div class="v mono" id="probDown">—</div>
            <span class="small" id="probState">—</span>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="medianLabel">Median 5d</div>
            <div class="v mono" id="probMedianReturn">—</div>
            <span class="small" id="probSpread">—</span>
          </div>
        </div>
        <div class="range-chip" id="rangeChip"></div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card" id="eventContextCard">
      <div class="section-title flex">
        <span data-i18n="eventContextTitle">Event Context</span>
        <span class="chip muted" id="eventPhaseChip">—</span>
        <span class="chip info" id="eventPriorityChip">—</span>
      </div>
      <div class="context-note" id="eventContextSummary">—</div>
      <div class="context-grid">
        <div class="kpi">
          <div class="muted" data-i18n="eventNameLabel">Event</div>
          <div class="v mono" id="eventName">—</div>
          <span class="small" id="eventTiming">—</span>
        </div>
        <div class="kpi">
          <div class="muted" data-i18n="volImpactLabel">Volatility context</div>
          <div class="v mono" id="eventVolNote">—</div>
          <span class="small" id="eventSampleSize">—</span>
        </div>
        <div class="kpi">
          <div class="muted" data-i18n="directionalNoteLabel">Directional note</div>
          <div class="v mono" id="eventDirection">—</div>
          <span class="small" id="eventConfidence">—</span>
        </div>
      </div>
      <div class="context-note" id="eventContextFooter">—</div>
    </div>

    <div style="height:16px"></div>

    <div class="card" id="contextCard">
      <div class="section-title flex">
        <span data-i18n="contextTitle">Cross-Market Context</span>
        <span class="chip muted" id="contextAsOf">—</span>
      </div>
      <div class="context-note" data-i18n="contextNote">Dollar / gold / rates framing; not a signal.</div>
      <div id="contextItems" class="context-grid"></div>
      <div class="context-note" id="contextFooter" data-i18n="contextFooter">Context only; not a trade idea.</div>
    </div>

    <div style="height:16px"></div>

    <div class="card" id="analogiesCard">
      <div class="section-title flex">
        <span data-i18n="analogiesTitle">Analogies</span>
        <span class="panel-label" data-i18n="analogiesNote">דומים היסטוריים · ללא הוראות</span>
      </div>
      <div id="analogyList" class="grid-2"></div>
    </div>

    <div style="height:16px"></div>

    <div class="card" id="deviationPanel">
      <div class="section-title flex">
        <span data-i18n="deviationPanelTitle">Deviation vs history</span>
        <span class="pill neutral" id="bandStateTag">—</span>
      </div>
      <div class="muted" id="deviationMeta">—</div>
      <div class="kpis" style="margin-top:10px;">
        <div class="kpi">
          <div class="muted" data-i18n="zNowLabel">Z-score now</div>
          <div class="v mono" id="zNow">—</div>
          <span class="small" id="zWindowLabel">—</span>
        </div>
        <div class="kpi">
          <div class="muted" data-i18n="pctNowLabel">Percentile now</div>
          <div class="v mono" id="pctNow">—</div>
          <span class="small" id="pctWindowLabel">—</span>
        </div>
        <div class="kpi">
          <div class="muted" data-i18n="bandLabel">Band</div>
          <div class="v mono" id="bandLabelNow">—</div>
          <span class="small" id="bandHint">—</span>
        </div>
      </div>
      <div class="mini-bar" aria-label="z-score position">
        <div class="mini-track"></div>
        <div class="mini-pointer" id="zPointer"></div>
        <div class="mini-label left">-3σ</div>
        <div class="mini-label right">+3σ</div>
      </div>
      <div class="subtitle" id="bandContext">—</div>
    </div>

    <div style="height:16px"></div>

    <div class="card" id="heatmapCard">
      <div class="section-title flex">
        <span data-i18n="heatmapTitle">Heatmap timeline</span>
        <span class="panel-label" data-i18n="heatmapNote">סטיות, תנודתיות, מומנטום · ללא BUY/SELL</span>
      </div>
      <div class="controls" style="margin-top:6px;">
        <div class="muted" data-i18n="viewLabel">View</div>
        <button class="btn active" data-heatmap="deviation" id="btnDeviation">Deviation</button>
        <button class="btn" data-heatmap="volatility" id="btnVolatility">Volatility</button>
        <button class="btn" data-heatmap="momentum" id="btnMomentum">Momentum</button>
        <span class="space"></span>
        <div class="muted" data-i18n="rangeLabel">טווח זמן:</div>
        <button class="btn" data-heatmap-range="3m">3M</button>
        <button class="btn" data-heatmap-range="1y">1Y</button>
        <button class="btn active" data-heatmap-range="all">All</button>
        <label class="toggle" style="margin-inline-start:8px;"><input type="checkbox" id="heatmapWeekly" /> <span data-i18n="weeklyAgg">Weekly</span></label>
      </div>
      <div id="heatmap" style="height:240px;"></div>
      <div class="muted" id="heatmapNote">—</div>
      <div class="band-grid" id="bandStats"></div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="section-title" data-i18n="anomalyNowTitle">Layer 1 · Alerts</div>
        <div class="muted" id="anomalyUpdated">—</div>
        <div class="flex" style="margin-top:8px; gap:12px;">
          <div>
            <div class="muted" data-i18n="anomalyScoreLabel">Anomaly score</div>
            <div class="big" id="anomalyScore">—</div>
          </div>
          <span class="pill neutral" id="trendTag">—</span>
          <span class="pill neutral" id="volTag">—</span>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="muted" data-i18n="adxLabel">ADX</div>
            <div class="v mono" id="adxVal">—</div>
            <span class="small" id="trendNote">—</span>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="atrLabel">ATR (14)</div>
            <div class="v mono" id="atrVal">—</div>
            <span class="small" id="volNote">—</span>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="alertCountLabel">Active alerts</div>
            <div class="v mono" id="alertCount">—</div>
            <span class="small" id="topAlert">—</span>
          </div>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="muted" data-i18n="latestCloseLabel">Latest Close</div>
            <div class="v mono" id="lastClose">—</div>
            <span class="small" id="mas">—</span>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="momLabel">1M Mom%</div>
            <div class="v mono" id="mom">—</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:12px;" data-i18n="alertListTitle">What is unusual</div>
        <div id="alertsContainer"></div>
      </div>

      <div class="card">
        <div class="section-title flex">
          <span data-i18n="backtestSettings">Backtest settings</span>
          <button class="btn" id="toggleSettings" style="margin-inline-start:auto;" data-i18n="openSettings">Open</button>
        </div>
        <div class="subtitle" data-i18n="settingsHint">שליטה מהירה לטווחי בדיקה, עלויות ואסטרטגיה.</div>
        <div id="settingsPanel" class="settings" style="display:none;">
          <div>
            <label class="small" data-i18n="startDate">Start date</label>
            <input type="date" id="startDate" />
          </div>
          <div>
            <label class="small" data-i18n="endDate">End date</label>
            <input type="date" id="endDate" />
          </div>
          <div>
            <label class="small" data-i18n="costsLabel">Costs (bps per trade)</label>
            <input type="number" id="costsInput" min="0" step="1" value="10" />
          </div>
          <div>
            <label class="small" data-i18n="strategyPick">Strategy</label>
            <select id="strategySelect">
              <option value="trend" data-i18n="strategyTrend">Trend</option>
              <option value="range" data-i18n="strategyRange">Range</option>
              <option value="hybrid" data-i18n="strategyHybrid" selected>Hybrid</option>
            </select>
          </div>
          <div>
            <label class="small" data-i18n="maWindow">MA window (trend filter)</label>
            <input type="number" id="maWindowInput" min="5" max="400" step="1" value="50" />
          </div>
          <div>
            <label class="small" data-i18n="rsiPeriod">RSI period</label>
            <input type="number" id="rsiPeriodInput" min="5" max="60" step="1" value="14" />
          </div>
          <div>
            <label class="small" data-i18n="rsiOversold">RSI oversold</label>
            <input type="number" id="rsiOversoldInput" min="1" max="60" step="1" value="35" />
          </div>
          <div>
            <label class="small" data-i18n="rsiOverbought">RSI overbought</label>
            <input type="number" id="rsiOverboughtInput" min="40" max="95" step="1" value="65" />
          </div>
          <div>
            <label class="small" data-i18n="bandWindow">Bollinger window</label>
            <input type="number" id="bandWindowInput" min="5" max="200" step="1" value="20" />
          </div>
          <div>
            <label class="small" data-i18n="bandStd">Band σ (std dev)</label>
            <input type="number" id="bandStdInput" min="1" max="4" step="0.1" value="2" />
          </div>
          <div>
            <label class="small" data-i18n="grossNet">Gross / Net</label>
            <div class="flex">
              <label class="toggle"><input type="radio" name="pnltoggle" value="gross" checked /> <span data-i18n="grossLabel">Gross</span></label>
              <label class="toggle"><input type="radio" name="pnltoggle" value="net" /> <span data-i18n="netLabel">Net</span></label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card">
      <div class="section-title flex">
        <span data-i18n="advancedTitle">Advanced</span>
        <button class="btn" id="advancedToggle" style="margin-inline-start:auto;" data-i18n="openSettings">Open</button>
      </div>
      <div class="subtitle" data-i18n="advancedSubtitle">Traces, trades, and backtests נשארים מאחורי כפתור “Advanced”.</div>
    </div>

    <div style="height:16px"></div>

    <div id="advancedPanel" style="display:none;">

    <div class="card">
      <div class="section-title" data-i18n="priceTitle">Price</div>
      <div class="controls">
        <div class="muted" data-i18n="rangeLabel">טווח זמן:</div>
        <button class="btn active" data-range="3m">3M</button>
        <button class="btn" data-range="1y">1Y</button>
        <button class="btn" data-range="all">All</button>
        <span class="space"></span>
        <label class="toggle"><input type="checkbox" id="toggleMa" checked /><span data-i18n="maToggle">MAs</span></label>
        <label class="toggle"><input type="checkbox" id="toggleBoll" checked /><span data-i18n="bollToggle">Bands</span></label>
        <label class="toggle"><input type="checkbox" id="toggleCycles" checked /><span data-i18n="cyclesToggle">Cycles</span></label>
      </div>
      <div id="chart" style="height:440px;"></div>
      <div class="muted" style="margin-top:8px;" data-i18n="cycleTitle">מחזורי Peaks/Troughs אחרונים</div>
      <table class="table" id="cycleTable">
        <thead>
          <tr>
            <th data-i18n="cycleEndDate">תאריך סיום</th>
            <th data-i18n="cycleStartDate">תאריך התחלה</th>
            <th data-i18n="cycleDirection">כיוון</th>
            <th data-i18n="cycleLength">אורך</th>
            <th data-i18n="cycleAmplitude">אמפליטודה</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="section-title" data-i18n="equityTitle">Equity vs Benchmark (SLV)</div>
        <div class="controls" style="margin-top:6px;">
          <span class="muted" data-i18n="equityViewLabel">View:</span>
          <label class="toggle"><input type="radio" name="equityMode" value="gross" checked /> <span data-i18n="grossLabel">Gross</span></label>
          <label class="toggle"><input type="radio" name="equityMode" value="net" /> <span data-i18n="netLabel">Net (after cost)</span></label>
          <span class="space"></span>
          <span class="muted" data-i18n="perfSummaryUpdatedLabel">עודכן</span>: <span class="mono" id="perfSummaryUpdated">—</span>
        </div>
        <div class="cost-impact" id="costImpact">
          <div><span data-i18n="costsSelectedLabel">Selected costs</span>: <strong class="mono" id="costsSelected">—</strong></div>
          <div><span data-i18n="costDragLabel">Cost drag vs gross</span>: <strong class="mono" id="costDragVal">—</strong></div>
          <div><span data-i18n="grossNetImpactLabel">Gross → Net</span>: <span class="mono" id="grossReturnVal">—</span> → <span class="mono" id="netReturnVal">—</span></div>
        </div>
        <div id="perfChart" style="height:320px;"></div>
        <table class="table" id="perfTable" style="margin-top:12px;">
          <thead>
            <tr>
              <th data-i18n="seriesLabel">Series</th>
              <th data-i18n="totalReturnLabel">Total Return</th>
              <th data-i18n="maxDrawdownLabel">Max Drawdown</th>
              <th data-i18n="sharpeLabel">Sharpe</th>
              <th data-i18n="sortinoLabel">Sortino</th>
            </tr>
          </thead>
          <tbody id="perfTableBody">
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="section-title" data-i18n="riskTitle">Risk metrics</div>
        <div class="kpis">
          <div class="kpi">
            <div class="muted" data-i18n="maxDrawdownLabel">Max Drawdown</div>
            <div class="v mono" id="riskDd">—</div>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="ulcerLabel">Ulcer Index</div>
            <div class="v mono" id="riskUlcer">—</div>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="worstMonthLabel">Worst Month</div>
            <div class="v mono" id="riskWorst">—</div>
          </div>
        </div>
        <div class="section-title" style="margin-top:16px;" data-i18n="tradeLogTitle">Trade log</div>
        <table class="table" id="tradeTable">
          <thead>
            <tr>
              <th data-i18n="tradeEntry">Entry</th>
              <th data-i18n="tradeExit">Exit</th>
              <th data-i18n="tradeReason">Trigger</th>
              <th data-i18n="tradeReturn">Return%</th>
              <th data-i18n="tradeHold">Hold</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card" id="performanceCard">
        <div class="section-title" data-i18n="performanceScoreTitle">ציון ביצועים כולל</div>
        <div class="muted"><span data-i18n="perfSummaryUpdatedLabel">עודכן</span>: <span class="mono" id="perfSummaryUpdated2">—</span></div>
        <div class="kpis">
          <div class="kpi">
            <div class="muted" data-i18n="algoScoreLabel">ציון אלגוריתם</div>
            <div class="v mono" id="algoScore">—</div>
            <span class="small" id="algoScoreMeta">—</span>
          </div>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="muted" data-i18n="hitRateLabel">Hit Rate</div>
            <div class="v mono" id="hitRate">—</div>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="avgReturn5dLabel">Avg Return 5d</div>
            <div class="v mono" id="avgReturn5d">—</div>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="avgReturn10dLabel">Avg Return 10d</div>
            <div class="v mono" id="avgReturn10d">—</div>
          </div>
          <div class="kpi">
            <div class="muted" data-i18n="maxDrawdownLabel">Max Drawdown</div>
            <div class="v mono" id="maxDrawdown">—</div>
          </div>
        </div>
      </div>

      <div class="card" id="decompCard">
        <div class="section-title" data-i18n="decompTitle">Decomposition</div>
        <div class="muted"><span data-i18n="decompUpdatedLabel">Updated</span>: <span class="mono" id="decompUpdated">—</span></div>
        <div class="muted"><span data-i18n="decompPeriodLabel">Period</span>: <span class="mono" id="decompPeriod">—</span></div>
        <div id="trendChart" style="height:180px; margin-top:10px;"></div>
        <div id="seasonalChart" style="height:180px; margin-top:10px;"></div>
      </div>
    </div>
    </div>
  </div>

<script>
async function getJson(path) {
  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) throw new Error(`Failed ${path}: ${r.status}`);
  return await r.json();
}

async function optionalJson(path) {
  try {
    return await getJson(path);
  } catch (err) {
    console.warn(`Optional JSON missing: ${path}`, err);
    return null;
  }
}

function detectLang() {
  const stored = localStorage.getItem("lang");
  if (stored) return stored;
  const nav = navigator.language || navigator.userLanguage || "";
  return nav.toLowerCase().startsWith("he") ? "he" : "en";
}

const translations = {
  he: {
    title: "SLV Monitor",
    subtitle: "דשבורד סטטי ב-GitHub Pages + “מוח” שרץ ב-GitHub Actions ומעדכן JSON.",
    alert: "המלצות המערכת הן תוצאה של עיבוד סטטיסטי ואינן מהוות ייעוץ או הנחיה לביצוע פעולה מיידית. מומלץ לשלב את האיתותים עם גורמים נוספים כמו חדשות מאקרו, מדיניות מוניטרית ושיקולים אישיים אחרים.",
    priceTitle: "מחיר",
    rangeLabel: "טווח זמן:",
    cycleTitle: "מחזורי Peaks/Troughs אחרונים",
    cycleEndDate: "תאריך סיום",
    cycleStartDate: "תאריך התחלה",
    cycleDirection: "כיוון",
    cycleLength: "אורך",
    cycleAmplitude: "אמפליטודה",
    performanceScoreTitle: "ציון ביצועים כולל",
    perfSummaryUpdatedLabel: "עודכן",
    equityTitle: "תשואת אלגו מול SLV",
    performanceTitle: "ביצועים",
    algoScoreLabel: "ציון אלגוריתם",
    sharpeLabel: "Sharpe Ratio",
    cycleCaptureLabel: "ציון מחזורי",
    rsiLabel: "RSI (14)",
    stdLabel: "סטיית תקן מתגלגלת (20)",
    macdLabel: "MACD (12/26/9)",
    bollLabel: "בולינגר (20, 2σ)",
    obvLabel: "OBV",
    maLongLabel: "MA1000",
    perfUpdatedLabel: "עדכון ביצועים",
    decompTitle: "פירוק (Decomposition)",
    decompUpdatedLabel: "עדכון",
    decompPeriodLabel: "אורך מחזור",
    trendTitle: "מגמה",
    seasonalTitle: "עונתיות / שארית",
    noCycles: "לא זוהו מחזורים עדיין.",
    perfSeriesUnavailable: "סדרת ביצועים לא זמינה.",
    benchUnavailable: "חלון מדד חסר.",
    decompUnavailable: "פירוק לא זמין.",
    seriesLabel: "סדרה",
    totalReturnLabel: "תשואה כוללת",
    sortinoLabel: "Sortino",
    strategyLabel: "אסטרטגיה",
    buyHoldLabel: "Buy & Hold",
    updatedPrefix: "עודכן (UTC)",
    metaSourceLabel: "מקור נתונים",
    metaCoverageLabel: "טווח כיסוי",
    metaUpdatedLabel: "עדכון אחרון",
    marketSnapshotTitle: "צילום מצב שוק",
    occurrencesLabel: "מספר מקרים",
    historicalRangeLabel: "טווח תוצאות נפוץ",
    whatItMeansTitle: "מה זה בדרך כלל אומר",
    analogiesTitle: "אנלוגיות",
    analogiesNote: "דומים היסטוריים · ללא הוראות",
    eventContextTitle: "הקשר אירועים",
    eventContextLabel: "קונטקסט אירוע",
    eventContextNone: "אין אירוע קרוב",
      contextTitle: "הקשר שווקים חוצה",
      contextNote: "דולר / זהב / ריביות · הקשר היסטורי בלבד",
      contextFooter: "הקשר בלבד; לא הבטחה או הנחיה.",
      contextHistLabel: "היסטורית (5 ימים)",
      contextHistFallback: "חסר מדגם היסטורי מספק",
      contextDisclaimer: "הקשר היסטורי בלבד; לא הבטחה.",
      contextLowSample: "מדגם קטן; הסקה חלשה.",
      contextValueLabel: "ערך נוכחי",
      contextZLabel: "Z-score",
      contextPctLabel: "אחוזון",
      contextPUp5d: "P(up 5d)",
      contextMedian5d: "חציון 5 ימים",
      contextPUp10d: "P(up 10d)",
      contextMedian10d: "חציון 10 ימים",
    eventPhasePre: "לפני אירוע",
    eventPhaseToday: "יום אירוע",
    eventPhasePost: "אחרי אירוע",
    eventPhaseUpcoming: "אירוע מתוזמן",
    eventNameLabel: "אירוע",
    volImpactLabel: "הקשר תנודתיות",
    directionalNoteLabel: "כיוון היסטורי",
    sampleSizeLabel: "מדגם",
    eventContextFooter: "הקשר בלבד; לא סיגנל או תחזית.",
    eventTimingLabel: "מרחק ליום אירוע",
    deviationPanelTitle: "סטייה מול היסטוריה",
    zNowLabel: "Z-score נוכחי",
    pctNowLabel: "אחוזון נוכחי",
    bandLabel: "Band",
    heatmapTitle: "מפת חום לאורך זמן",
    heatmapNote: "צבע הוא הקשר, לא הוראה. Hover → מספרים.",
    viewLabel: "תצוגה",
    weeklyAgg: "שבועי",
    limitsCopy: "הנתונים היסטוריים בלבד; לא התחייבות לתוצאה.",
    medianLabel: "חציון 5 ימים",
    advancedTitle: "Advanced",
    advancedSubtitle: "רכיב הטריידים והבקטסט נמצא ב-Advanced.",
    confidenceLabel: "Confidence",
    scoreTotalLabel: "Score Total",
    scorePriceLabel: "Price Score",
    scoreCOTLabel: "COT Score",
    latestCloseLabel: "מחיר סגירה אחרון",
    maLabel: "ממוצעים 20/50/200",
    momLabel: "מומנטום 1M",
    cotLabel: "COT (Silver)",
    edgarLabel: "EDGAR",
    cotUnavailable: "COT לא זמין (בינתיים).",
    edgarNoFiling: "לא נמצאה הגשה אחרונה.",
    edgarUnavailable: "EDGAR לא זמין (בינתיים).",
    hitRateLabel: "Hit Rate",
    avgReturn5dLabel: "תשואה ממוצעת 5 ימים",
    avgReturn10dLabel: "תשואה ממוצעת 10 ימים",
    maxDrawdownLabel: "Max Drawdown",
    rsiToggle: "RSI",
    stdToggle: "StdDev",
    macdToggle: "MACD",
    bollToggle: "בולינגר",
    obvToggle: "OBV",
    maLongToggle: "MA1000",
    decompToggle: "Decomposition",
    langToggleEnglish: "English",
    langToggleHebrew: "עברית",
    switchToEnglishAria: "Switch to English",
    switchToHebrewAria: "החלף לעברית",
    anomalyNowTitle: "התראות חריגות (Layer 1)",
    anomalyScoreLabel: "מדד חריגות",
    adxLabel: "ADX",
    atrLabel: "ATR (14)",
    alertCountLabel: "Alerts",
    alertListTitle: "מה חריג היום",
    cyclesToggle: "מחזורי מחיר",
    noAlerts: "אין חריגות חזקות היום.",
    backtestSettings: "Backtest settings",
    openSettings: "Open",
    settingsHint: "שליטה מהירה לטווחי בדיקה, עלויות ואסטרטגיה.",
    maWindow: "חלון MA (מסנן מגמה)",
    rsiPeriod: "תקופת RSI",
    rsiOversold: "RSI מכירות יתר",
    rsiOverbought: "RSI קניות יתר",
    bandWindow: "חלון בולינגר",
    bandStd: "סטיית תקן",
    startDate: "Start date",
    endDate: "End date",
    costsLabel: "עלויות (bps)",
    costsSelectedLabel: "עלות נבחרת (bps לעסקה)",
    costDragLabel: "שחיקה מול תשואת Gross",
    grossNetImpactLabel: "תשואה: Gross → Net",
    strategyPick: "Strategy",
    strategyTrend: "Trend",
    strategyRange: "Range",
    strategyHybrid: "Hybrid",
    grossNet: "Gross / Net",
    grossLabel: "Gross",
    netLabel: "Net",
    maToggle: "MAs",
    signalsToggle: "Buy/Sell",
    equityViewLabel: "תצוגת רווחיות",
    riskTitle: "מדדי סיכון",
    ulcerLabel: "Ulcer Index",
    worstMonthLabel: "Worst month",
    tradeLogTitle: "יומן עסקאות",
    tradeEntry: "כניסה",
    tradeExit: "יציאה",
    tradeReason: "Trigger",
    tradeReturn: "רווח %",
    tradeHold: "זמן החזקה"
  },
  en: {
    title: "SLV Monitor",
    subtitle: "Static dashboard on GitHub Pages + a 'brain' running in GitHub Actions updating JSON.",
    alert: "System recommendations are the result of statistical processing and do not constitute advice or a call for immediate action. Combine signals with other factors like macro news, monetary policy, and personal considerations.",
    priceTitle: "Price",
    rangeLabel: "Range:",
    cycleTitle: "Recent Peaks/Troughs Cycles",
    cycleEndDate: "End Date",
    cycleStartDate: "Start Date",
    cycleDirection: "Direction",
    cycleLength: "Length",
    cycleAmplitude: "Amplitude",
    performanceScoreTitle: "Performance Scorecard",
    perfSummaryUpdatedLabel: "Updated",
    equityTitle: "Equity vs Benchmark (SLV)",
    performanceTitle: "Performance",
    algoScoreLabel: "Algorithm Score",
    sharpeLabel: "Sharpe Ratio",
    cycleCaptureLabel: "Cycle Capture",
    rsiLabel: "RSI (14)",
    stdLabel: "Rolling StdDev (20)",
    macdLabel: "MACD (12/26/9)",
    bollLabel: "Bollinger Bands (20, 2σ)",
    obvLabel: "OBV",
    maLongLabel: "MA1000",
    perfUpdatedLabel: "Perf Updated",
    decompTitle: "Decomposition",
    decompUpdatedLabel: "Updated",
    decompPeriodLabel: "Period",
    trendTitle: "Trend",
    seasonalTitle: "Seasonal / Residual",
    noCycles: "No cycles detected yet.",
    perfSeriesUnavailable: "Performance series unavailable.",
    benchUnavailable: "Benchmark window unavailable.",
    decompUnavailable: "Decomposition unavailable.",
    seriesLabel: "Series",
    totalReturnLabel: "Total Return",
    sortinoLabel: "Sortino",
    strategyLabel: "Strategy",
    buyHoldLabel: "Buy & Hold",
    updatedPrefix: "Updated (UTC)",
    metaSourceLabel: "Data source",
    metaCoverageLabel: "Coverage",
    metaUpdatedLabel: "Last updated",
    marketSnapshotTitle: "Market Snapshot",
    occurrencesLabel: "Occurrences",
    historicalRangeLabel: "Common range (5d)",
    whatItMeansTitle: "What this usually means",
    analogiesTitle: "Analogies",
    analogiesNote: "Historical peers · No instructions",
    eventContextTitle: "Event Context",
    eventContextLabel: "Event Context",
    eventContextNone: "No known event window",
      contextTitle: "Cross-Market Context",
      contextNote: "Dollar / gold / rates framing; historical only.",
      contextFooter: "Context only; not a trading instruction.",
      contextHistLabel: "Historical (5d)",
      contextHistFallback: "Insufficient history for this bucket",
      contextDisclaimer: "Historical context only; not a promise.",
      contextLowSample: "Low sample size; weak context.",
      contextValueLabel: "Value",
      contextZLabel: "Z-score",
      contextPctLabel: "Percentile",
      contextPUp5d: "P(up 5d)",
      contextMedian5d: "Median 5d",
      contextPUp10d: "P(up 10d)",
      contextMedian10d: "Median 10d",
    eventPhasePre: "Pre-event",
    eventPhaseToday: "Event day",
    eventPhasePost: "Post-event",
    eventPhaseUpcoming: "Scheduled",
    eventNameLabel: "Event",
    volImpactLabel: "Volatility context",
    directionalNoteLabel: "Directional note",
    sampleSizeLabel: "Sample size",
    eventContextFooter: "Context only; not a trigger or forecast.",
    eventTimingLabel: "Distance to event",
    deviationPanelTitle: "Deviation vs history",
    zNowLabel: "Z-score now",
    pctNowLabel: "Percentile now",
    bandLabel: "Band",
    heatmapTitle: "Heatmap timeline",
    heatmapNote: "Color = context only. Hover to see numbers.",
    viewLabel: "View",
    weeklyAgg: "Weekly",
    limitsCopy: "Historical only; not a promise.",
    medianLabel: "Median 5d",
    advancedTitle: "Advanced",
    advancedSubtitle: "Trades and backtests live behind the Advanced toggle.",
    confidenceLabel: "Confidence",
    scoreTotalLabel: "Score Total",
    scorePriceLabel: "Price Score",
    scoreCOTLabel: "COT Score",
    latestCloseLabel: "Latest Close",
    maLabel: "MA20/50/200",
    momLabel: "1M Mom%",
    cotLabel: "COT (Silver)",
    edgarLabel: "EDGAR",
    cotUnavailable: "COT unavailable (yet).",
    edgarNoFiling: "No latest filing found.",
    edgarUnavailable: "EDGAR unavailable (yet).",
    hitRateLabel: "Hit Rate",
    avgReturn5dLabel: "Avg Return 5d",
    avgReturn10dLabel: "Avg Return 10d",
    maxDrawdownLabel: "Max Drawdown",
    rsiToggle: "RSI",
    stdToggle: "StdDev",
    macdToggle: "MACD",
    bollToggle: "Bollinger",
    obvToggle: "OBV",
    maLongToggle: "MA1000",
    decompToggle: "Decomposition",
    langToggleEnglish: "English",
    langToggleHebrew: "עברית",
    switchToEnglishAria: "Switch to English",
    switchToHebrewAria: "Switch to Hebrew",
    anomalyNowTitle: "Layer 1 · Alerts",
    anomalyScoreLabel: "Anomaly score",
    adxLabel: "ADX",
    atrLabel: "ATR (14)",
    alertCountLabel: "Alerts",
    alertListTitle: "What is unusual",
    cyclesToggle: "Cycles",
    noAlerts: "No strong anomalies today.",
    backtestSettings: "Backtest settings",
    openSettings: "Open",
    settingsHint: "Quick control over test window, costs and regime.",
    maWindow: "MA window (trend filter)",
    rsiPeriod: "RSI period",
    rsiOversold: "RSI oversold",
    rsiOverbought: "RSI overbought",
    bandWindow: "Bollinger window",
    bandStd: "Band σ (std dev)",
    startDate: "Start date",
    endDate: "End date",
    costsLabel: "Costs (bps)",
    costsSelectedLabel: "Selected costs (bps per trade)",
    costDragLabel: "Cost drag vs gross return",
    grossNetImpactLabel: "Gross → Net return",
    strategyPick: "Strategy",
    strategyTrend: "Trend",
    strategyRange: "Range",
    strategyHybrid: "Hybrid",
    grossNet: "Gross / Net",
    grossLabel: "Gross",
    netLabel: "Net",
    maToggle: "MAs",
    signalsToggle: "Buy/Sell",
    equityViewLabel: "Equity view",
    riskTitle: "Risk metrics",
    ulcerLabel: "Ulcer Index",
    worstMonthLabel: "Worst month",
    tradeLogTitle: "Trade log",
    tradeEntry: "Entry",
    tradeExit: "Exit",
    tradeReason: "Trigger",
    tradeReturn: "Return%",
    tradeHold: "Hold"
  }
};

function fmt(x, d = 2) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return Number(x).toFixed(d);
}

function fmtPct(x, d = 1) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return `${(Number(x) * 100).toFixed(d)}%`;
}

function movingAverage(arr, period) {
  const res = [];
  for (let i = 0; i < arr.length; i++) {
    if (i + 1 < period) { res.push(null); continue; }
    const slice = arr.slice(i + 1 - period, i + 1);
    const avg = slice.reduce((a, b) => a + b, 0) / period;
    res.push(avg);
  }
  return res;
}

function bollinger(arr, period = 20, mult = 2) {
  const ma = movingAverage(arr, period);
  const upper = [];
  const lower = [];
  for (let i = 0; i < arr.length; i++) {
    if (i + 1 < period) { upper.push(null); lower.push(null); continue; }
    const slice = arr.slice(i + 1 - period, i + 1);
    const mean = ma[i];
    const variance = slice.reduce((acc, v) => acc + (v - mean) ** 2, 0) / period;
    const std = Math.sqrt(variance);
    upper.push(mean + mult * std);
    lower.push(mean - mult * std);
  }
  return { ma, upper, lower };
}

function computeRsi(arr, period = 14) {
  const gains = [];
  const losses = [];
  for (let i = 1; i < arr.length; i++) {
    const change = arr[i] - arr[i - 1];
    gains.push(Math.max(change, 0));
    losses.push(Math.max(-change, 0));
  }
  const rsi = [null];
  for (let i = 1; i < arr.length; i++) {
    if (i < period) { rsi.push(null); continue; }
    const gainSlice = gains.slice(i - period, i);
    const lossSlice = losses.slice(i - period, i);
    const avgGain = gainSlice.reduce((a, b) => a + b, 0) / period;
    const avgLoss = lossSlice.reduce((a, b) => a + b, 0) / period;
    const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
    const value = 100 - 100 / (1 + rs);
    rsi.push(value);
  }
  return rsi;
}

function normalizeEquityFromPrices(prices) {
  const eq = [{ index: 0, equity: 1 }];
  for (let i = 1; i < prices.length; i++) {
    const prev = prices[i - 1];
    const curr = prices[i];
    const ret = (curr - prev) / prev;
    const last = eq[eq.length - 1].equity;
    eq.push({ index: i, equity: last * (1 + ret) });
  }
  return eq.slice(1);
}

function applyCosts(equitySeries, costBps = 0.0) {
  const cost = costBps / 10000;
  if (!cost) return equitySeries;
  const out = [];
  for (let i = 0; i < equitySeries.length; i++) {
    if (i === 0) { out.push({ ...equitySeries[i] }); continue; }
    const prev = equitySeries[i - 1].equity;
    const curr = equitySeries[i].equity;
    const grossRet = curr / prev - 1;
    const netRet = grossRet - cost;
    out.push({ index: equitySeries[i].index, equity: out[i - 1].equity * (1 + netRet) });
  }
  return out;
}

(async () => {
  const [meta, prices, probabilistic, anomalies, decomposition, perfSummary, equityCurve, cycleStats, heatmapDeviation, heatmapVolatility, heatmapMomentum, statsByBand, eventContext, eventImpactStats, currentContextRaw, conditionalContextStatsRaw] = await Promise.all([
    getJson("./public/data/meta.json"),
    getJson("./data/slv_prices.json"),
    getJson("./public/data/signals/probabilistic.json"),
    getJson("./public/data/anomalies/latest.json"),
    getJson("./public/data/perf/decomposition.json"),
    getJson("./public/data/perf/summary.json"),
    getJson("./public/data/perf/equity_curve.json"),
    getJson("./public/data/events/cycle_stats.json"),
    optionalJson("./public/data/heatmap/deviation.json"),
    optionalJson("./public/data/heatmap/volatility.json"),
    optionalJson("./public/data/heatmap/momentum.json"),
    optionalJson("./public/data/heatmap/stats_by_band.json"),
      optionalJson("./public/data/events/current_event_context.json"),
      optionalJson("./public/data/events/event_impact_stats.json"),
      optionalJson("./public/data/context/cross_market_current.json"),
      optionalJson("./public/data/context/cross_market_conditional.json"),
    ]);

    const currentContext = currentContextRaw || (await optionalJson("./public/data/context/current_context.json"));
    const conditionalContextStats = conditionalContextStatsRaw || (await optionalJson("./public/data/context/conditional_stats.json"));

    const priceDates = prices.dates.map((d) => new Date(d));
  const state = {
    range: "3m",
    lang: detectLang(),
    showMa: true,
    showBoll: true,
    showCycles: true,
    showNet: false,
    costBps: 10,
    startDate: prices.dates[0],
    endDate: prices.dates[prices.dates.length - 1],
    maWindow: 50,
    rsiPeriod: 14,
    rsiOversold: 35,
    rsiOverbought: 65,
    bandWindow: 20,
    bandStd: 2,
    heatmapMode: "deviation",
    heatmapRange: "all",
    heatmapWeekly: false,
  };
  const buyHoldCurve = normalizeEquityFromPrices(prices.close);
  let lastBacktest = null;
  const heatmaps = {
    deviation: heatmapDeviation,
    volatility: heatmapVolatility,
    momentum: heatmapMomentum,
    stats: statsByBand,
  };

  function t(key) { return translations[state.lang]?.[key] ?? translations.en[key] ?? key; }

  function applyLanguage() {
    document.documentElement.lang = state.lang;
    document.body.dir = state.lang === "he" ? "rtl" : "ltr";
    document.querySelectorAll("[data-i18n]").forEach((el) => {
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    const langBtn = document.getElementById("langToggle");
    langBtn.textContent = state.lang === "he" ? translations.en.langToggleEnglish : translations.he.langToggleHebrew;
    langBtn.setAttribute("aria-label", state.lang === "he" ? translations.en.switchToEnglishAria : translations.he.switchToHebrewAria);
  }

  function eventPhaseLabel(status) {
    if (status === "PRE_EVENT") return t("eventPhasePre");
    if (status === "EVENT_DAY") return t("eventPhaseToday");
    if (status === "POST_EVENT") return t("eventPhasePost");
    if (status === "UPCOMING") return t("eventPhaseUpcoming");
    return t("eventContextNone");
  }

  function eventTimingText(context) {
    if (!context || typeof context.days_to_event !== "number") return "—";
    if (context.days_to_event === 0) return t("eventPhaseToday");
    const days = Math.abs(context.days_to_event);
    return context.days_to_event > 0 ? `${days}d ${t("eventTimingLabel")}` : `${days}d ${t("eventPhasePost")}`;
  }

  function renderEventContext(context) {
    const badge = document.getElementById("eventContextBadge");
    const card = document.getElementById("eventContextCard");
    if (!context || context.status === "NO_EVENT") {
      badge.textContent = t("eventContextNone");
      card.style.display = "none";
      return;
    }

    const phaseText = eventPhaseLabel(context.status);
    const timing = eventTimingText(context);
    badge.textContent = `${t("eventContextLabel")}: ${context.event ?? "—"} • ${phaseText}${timing ? ` (${timing})` : ""}`;
    card.style.display = "block";
    document.getElementById("eventPhaseChip").textContent = phaseText;
    document.getElementById("eventPriorityChip").textContent = context.priority ? context.priority.toUpperCase() : "—";
    document.getElementById("eventName").textContent = context.event ?? "—";
    document.getElementById("eventTiming").textContent = eventTimingText(context);
    document.getElementById("eventVolNote").textContent = context.historical_note ?? "—";
    document.getElementById("eventDirection").textContent = context.directional_note ?? "—";
    document.getElementById("eventSampleSize").textContent = context.sample_size
      ? `${t("sampleSizeLabel")}: n=${context.sample_size}`
      : t("sampleSizeLabel");
    const conf = context.confidence ? context.confidence : "";
    document.getElementById("eventConfidence").textContent = conf
      ? `${t("confidenceLabel")}: ${conf}`
      : t("confidenceLabel");

    const description = [phaseText, context.description].filter(Boolean).join(" · ");
    const hist = context.historical_note || "";
    const dir = context.directional_note || "";
    const pieces = [description, hist, dir].filter(Boolean);
    document.getElementById("eventContextSummary").textContent = pieces.join(" · ");
    document.getElementById("eventContextFooter").textContent = t("eventContextFooter");
  }

  function renderContextPanel(currentContext, conditionalStats) {
    const card = document.getElementById("contextCard");
    if (!card) return;
    if (!currentContext || !Array.isArray(currentContext.items) || !currentContext.items.length) {
      card.style.display = "none";
      return;
    }
    card.style.display = "block";
    const baseline = currentContext.baseline;
    const baselineText = baseline ? `z=${baseline.window_z} · pct=${baseline.window_pct}` : "";
    document.getElementById("contextAsOf").textContent = currentContext.asof
      ? `${t("updatedPrefix")}: ${currentContext.asof}${baselineText ? ` (${baselineText})` : ""}`
      : "—";
    const container = document.getElementById("contextItems");
    container.innerHTML = currentContext.items
      .map((item) => {
        const bucket = item.band || item.bucket;
        const stats = bucket ? conditionalStats?.[item.key]?.[bucket] || item.stats : null;
        const pctText = item.pct === null || item.pct === undefined ? "—" : `${item.pct.toFixed(1)}p`;
        const confidence = stats?.confidence || item.confidence || "low";
        const sampleSize = stats?.n ?? item.n_band ?? 0;
        const lowSample = confidence === "low" || (baseline && sampleSize < baseline.min_occurrences);
        const statBlock = (label, value, formatter = (v) => fmt(v, 2)) => `
          <div class="stat-block">
            <div class="stat-label">${label}</div>
            <div class="stat-value">${formatter(value)}</div>
          </div>`;
        return `
          <div class="context-item-card ${lowSample ? "context-low-confidence" : ""}">
            <div class="context-row">
              <div class="context-name">${item.name || item.key}</div>
              <span class="pill ${bandClass(bucket)}">${bandLabel(bucket)}</span>
            </div>
            <div class="context-row stat-pair">
              ${statBlock(t("contextValueLabel"), item.value)}
              ${statBlock(t("contextZLabel"), item.z)}
              ${statBlock(t("contextPctLabel"), pctText, (v) => v)}
            </div>
            <div class="context-row stat-pair">
              ${statBlock(t("contextPUp5d"), stats?.p_up_5d, (v) => fmtPct(v, 1))}
              ${statBlock(t("contextMedian5d"), stats?.median_5d, (v) => fmtPct(v, 2))}
            </div>
            <div class="context-row stat-pair">
              ${statBlock(t("contextPUp10d"), stats?.p_up_10d, (v) => fmtPct(v, 1))}
              ${statBlock(t("contextMedian10d"), stats?.median_10d, (v) => fmtPct(v, 2))}
            </div>
            <div class="context-row">
              <div class="stat-label">n=${sampleSize}</div>
              <span class="chip muted">${t("confidenceLabel")}: ${confidence}</span>
            </div>
            ${lowSample ? `<div class="context-warning">${t("contextLowSample")}</div>` : ""}
            <div class="context-note">${item.note || t("contextFooter")}</div>
            <div class="context-note">${t("contextDisclaimer")}</div>
          </div>
        `;
      })
      .join("");
    const footer = document.getElementById("contextFooter");
    if (footer) footer.textContent = t("contextFooter");
  }

  function bandLabel(band) {
    if (!band) return "—";
    return band.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
  }

  function bandClass(band) {
    if (!band) return "neutral";
    const key = band.toLowerCase();
    if (key.includes("extreme_high")) return "extreme-high";
    if (key === "high") return "high";
    if (key === "neutral") return "neutral";
    if (key === "low") return "low";
    if (key.includes("extreme_low")) return "extreme-low";
    return "neutral";
  }

  function clamp(val, min, max) {
    return Math.min(Math.max(val, min), max);
  }

  function renderDeviationPanel() {
    const payload = heatmaps.deviation;
    const latest = payload?.latest;
    const band = latest?.band;
    const tag = document.getElementById("bandStateTag");
    tag.textContent = bandLabel(band);
    tag.className = `pill ${bandClass(band)}`;

    document.getElementById("zNow").textContent = fmt(latest?.z, 2);
    document.getElementById("pctNow").textContent = latest?.pct === undefined || latest?.pct === null ? "—" : `${latest.pct.toFixed(1)}p`;
    document.getElementById("bandLabelNow").textContent = bandLabel(band);
    document.getElementById("zWindowLabel").textContent = payload ? `${t("stdLabel")}: ${payload.std_window}` : "—";
    document.getElementById("pctWindowLabel").textContent = payload ? `${t("pctNowLabel")}: ${payload.percentile_window}` : "—";
    document.getElementById("bandHint").textContent = t("heatmapNote");

    const baselineDesc = payload?.baseline ? `${payload.baseline.type}${payload.baseline.window}` : "—";
    document.getElementById("deviationMeta").textContent = payload ? `${baselineDesc} · σ=${payload.std_window} · pct=${payload.percentile_window}` : "—";

    const pointer = document.getElementById("zPointer");
    const zVal = typeof latest?.z === "number" ? clamp(latest.z, -3, 3) : 0;
    const pos = ((zVal + 3) / 6) * 100;
    pointer.style.left = `${pos}%`;

    const stats = band && heatmaps.stats?.bands ? heatmaps.stats.bands[band] : null;
    if (stats && stats.n) {
      const up5 = stats.p_up_5d;
      const med5 = stats.median_5d;
      document.getElementById("bandContext").textContent = `Among ${stats.n} days in ${bandLabel(band)}, P(up 5d)=${fmtPct(up5, 1)}, median 5d=${fmtPct(med5, 2)}.`;
    } else {
      document.getElementById("bandContext").textContent = t("heatmapNote");
    }
  }

  function isoWeekKey(dateStr) {
    const d = new Date(dateStr);
    const day = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - day);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, "0")}`;
  }

  function aggregateWeekly(rows) {
    const buckets = {};
    rows.forEach((row) => {
      const key = isoWeekKey(row.date);
      buckets[key] = row;
    });
    return Object.values(buckets).sort((a, b) => new Date(a.date) - new Date(b.date));
  }

  function mapBandValue(band, mapping) {
    if (!band) return null;
    return mapping[band] ?? null;
  }

  function renderHeatmap() {
    const mode = state.heatmapMode;
    const payload = heatmaps[mode];
    const rows = Array.isArray(payload?.rows) ? payload.rows : [];
    const noteEl = document.getElementById("heatmapNote");
    if (!rows.length) {
      document.getElementById("heatmap").textContent = t("perfSeriesUnavailable");
      noteEl.textContent = t("heatmapNote");
      return;
    }

    const months = state.heatmapRange === "3m" ? 3 : state.heatmapRange === "1y" ? 12 : null;
    let filtered = state.heatmapWeekly ? aggregateWeekly(rows) : rows.slice();
    if (months) {
      const lastDate = new Date(filtered[filtered.length - 1].date);
      const start = new Date(lastDate);
      start.setMonth(start.getMonth() - months);
      filtered = filtered.filter((r) => new Date(r.date) >= start);
    }

    const mapping =
      mode === "deviation"
        ? { EXTREME_LOW: -2, LOW: -1, NEUTRAL: 0, HIGH: 1, EXTREME_HIGH: 2 }
        : { LOW: -1, NORMAL: 0, HIGH: 1, BEARISH: -1, NEUTRAL: 0, BULLISH: 1 };

    const x = filtered.map((r) => r.date);
    const values = filtered.map((r) => {
      const bandKey = mode === "deviation" ? r.band : mode === "volatility" ? r.vol_bucket : r.mom_bucket;
      return mapBandValue(bandKey, mapping);
    });
    const text = filtered.map((r) => {
      const bandKey = mode === "deviation" ? r.band : mode === "volatility" ? r.vol_bucket : r.mom_bucket;
      const parts = [
        `Date: ${r.date}`,
        r.close !== undefined ? `Close: ${fmt(r.close, 2)}` : null,
        mode === "deviation" && r.z !== undefined ? `z=${fmt(r.z, 2)}, pct=${r.pct ?? "—"}` : null,
        mode === "volatility" && r.atr_pct !== undefined ? `ATR%=${fmtPct(r.atr_pct, 2)}` : null,
        mode === "momentum" && r.roc_20 !== undefined ? `ROC20=${fmtPct(r.roc_20, 2)}` : null,
        `Bucket: ${bandLabel(bandKey)}`,
      ].filter(Boolean);
      return parts.join("<br>");
    });

    const colorscale =
      mode === "deviation"
        ? [
            [0, "#1d4ed8"],
            [0.25, "#60a5fa"],
            [0.5, "#6b7280"],
            [0.75, "#fb923c"],
            [1, "#ef4444"],
          ]
        : mode === "volatility"
          ? [
              [0, "#60a5fa"],
              [0.5, "#6b7280"],
              [1, "#f59e0b"],
            ]
          : [
              [0, "#ef4444"],
              [0.5, "#6b7280"],
              [1, "#22c55e"],
            ];

    const zmin = mode === "deviation" ? -2 : -1;
    const zmax = mode === "deviation" ? 2 : 1;
    Plotly.newPlot(
      "heatmap",
      [
        {
          x,
          y: [mode === "deviation" ? "Deviation" : mode === "volatility" ? "Vol" : "Momentum"],
          z: [values],
          text: [text],
          type: "heatmap",
          colorscale,
          hovertemplate: "%{text}<extra></extra>",
          showscale: false,
          zmin,
          zmax,
        },
      ],
      {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { l: 45, r: 10, t: 10, b: 40 },
        xaxis: { showgrid: false, color: "#a8b4d6" },
        yaxis: { showgrid: false, color: "#a8b4d6" },
      },
      { displayModeBar: false },
    );

    const baseline = payload?.baseline ? `${payload.baseline.type}${payload.baseline.window}` : "";
    if (mode === "deviation") {
      noteEl.textContent = `${t("heatmapNote")}${baseline ? ` · Baseline ${baseline}` : ""}`;
    } else if (mode === "volatility") {
      noteEl.textContent = `${t("heatmapNote")} · ATR% low=${fmt(payload?.thresholds?.low, 4)}, high=${fmt(payload?.thresholds?.high, 4)}`;
    } else {
      noteEl.textContent = `${t("heatmapNote")} · ROC20 bear=${fmtPct(payload?.thresholds?.bear, 2)}, bull=${fmtPct(payload?.thresholds?.bull, 2)}`;
    }
  }

  function renderBandStats() {
    const stats = heatmaps.stats;
    const container = document.getElementById("bandStats");
    if (!stats || !stats.bands) {
      container.textContent = t("perfSeriesUnavailable");
      return;
    }
    const order = ["EXTREME_HIGH", "HIGH", "NEUTRAL", "LOW", "EXTREME_LOW"];
    container.innerHTML = order
      .map((band) => {
        const s = stats.bands[band];
        if (!s) return "";
        const label = bandLabel(band);
        return `
          <div class="band-card">
            <div class="title"><span class="pill ${bandClass(band)}">${label}</span><span class="muted">n=${s.n}</span></div>
            <div class="stat">P(up 5d): ${fmtPct(s.p_up_5d, 1)} · Median 5d: ${fmtPct(s.median_5d, 2)}</div>
            <div class="stat">P(up 10d): ${fmtPct(s.p_up_10d, 1)} · Median 10d: ${fmtPct(s.median_10d, 2)}</div>
          </div>
        `;
      })
      .join("");
  }

  function attachHeatmapControls() {
    document.querySelectorAll("[data-heatmap]").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("[data-heatmap]").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.heatmapMode = btn.getAttribute("data-heatmap");
        renderHeatmap();
      });
    });

    document.querySelectorAll("[data-heatmap-range]").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("[data-heatmap-range]").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.heatmapRange = btn.getAttribute("data-heatmap-range");
        renderHeatmap();
      });
    });

    const weekly = document.getElementById("heatmapWeekly");
    weekly.addEventListener("change", (e) => {
      state.heatmapWeekly = e.target.checked;
      renderHeatmap();
    });
  }

  function renderMeta() {
    const symbolText = meta?.symbol ? ` (${meta.symbol})` : "";
    const sourceText = meta?.source ? `${meta.source}${symbolText}` : "—";
    const coverageCore = meta?.start && meta?.end ? `${meta.start} → ${meta.end}` : "—";
    const rowsSuffix = Number.isFinite(meta?.rows) ? ` (${Number(meta.rows).toLocaleString()})` : "";

    document.getElementById("metaSource").textContent = sourceText;
    document.getElementById("metaCoverage").textContent = coverageCore === "—" ? "—" : `${coverageCore}${rowsSuffix}`;
    document.getElementById("metaUpdated").textContent = meta?.last_updated_utc ?? "—";
  }

  function getRangeMask(months, startDate, endDate) {
    const mask = [];
    const startBound = startDate ? new Date(startDate) : null;
    const endBound = endDate ? new Date(endDate) : null;
    const rangeStart = (() => {
      if (!months) return null;
      const lastDate = priceDates[priceDates.length - 1];
      const start = new Date(lastDate);
      start.setMonth(start.getMonth() - months);
      return start;
    })();

    priceDates.forEach((d, i) => {
      if (rangeStart && d < rangeStart) return;
      if (startBound && d < startBound) return;
      if (endBound && d > endBound) return;
      mask.push(i);
    });
    return mask;
  }

  function applyMask(arr, mask, accessor) {
    if (!Array.isArray(arr)) return [];
    return mask.map((i) => (accessor ? accessor(arr[i], i) : arr[i])).filter((v) => v !== undefined);
  }

  function renderPrice(range) {
    const months = range === "3m" ? 3 : range === "1y" ? 12 : null;
    const mask = getRangeMask(months, state.startDate, state.endDate);
    const dates = applyMask(prices.dates, mask);
    const close = applyMask(prices.close, mask);

    const opens = close.map((c, i) => (i === 0 ? c : close[i - 1]));
    const highs = close.map((c, i) => Math.max(c, opens[i]) * 1.002);
    const lows = close.map((c, i) => Math.min(c, opens[i]) * 0.998);

    const candle = { x: dates, open: opens, high: highs, low: lows, close, type: "candlestick", name: "SLV", increasing: { line: { color: "#22c55e" } }, decreasing: { line: { color: "#f43f5e" } } };

    const traces = [candle];
    if (state.showMa) {
      const ma20 = applyMask(movingAverage(prices.close, 20), mask);
      const ma50 = applyMask(movingAverage(prices.close, 50), mask);
      const ma200 = applyMask(movingAverage(prices.close, 200), mask);
      traces.push({ x: dates, y: ma20, mode: "lines", name: "MA20", line: { color: "#8bb2ff", width: 1.5 } });
      traces.push({ x: dates, y: ma50, mode: "lines", name: "MA50", line: { color: "#fbbf24", width: 1.2, dash: "dot" } });
      traces.push({ x: dates, y: ma200, mode: "lines", name: "MA200", line: { color: "#a855f7", width: 1.4, dash: "dash" } });
    }

    if (state.showBoll) {
      const bands = bollinger(prices.close, 20, 2);
      traces.push({ x: dates, y: applyMask(bands.upper, mask), mode: "lines", name: "Upper Band", line: { color: "rgba(255,255,255,0.35)", width: 1 } });
      traces.push({ x: dates, y: applyMask(bands.lower, mask), mode: "lines", name: "Lower Band", line: { color: "rgba(255,255,255,0.35)", width: 1 } });
    }

    const turningPoints = (cycleStats?.turning_points ?? []).filter((p) => {
      const d = new Date(p.date);
      if (state.startDate && d < new Date(state.startDate)) return false;
      if (state.endDate && d > new Date(state.endDate)) return false;
      if (!months) return true;
      const start = new Date(priceDates[priceDates.length - 1]);
      start.setMonth(start.getMonth() - months);
      return d >= start;
    });

    if (state.showCycles && turningPoints.length) {
      const buys = turningPoints.filter((p) => p.kind === "trough");
      const sells = turningPoints.filter((p) => p.kind === "peak");
      traces.push({ x: buys.map((p) => p.date), y: buys.map((p) => p.close), mode: "markers", type: "scatter", name: "Trough", marker: { color: "#22c55e", size: 9, symbol: "triangle-up" } });
      traces.push({ x: sells.map((p) => p.date), y: sells.map((p) => p.close), mode: "markers", type: "scatter", name: "Peak", marker: { color: "#f43f5e", size: 9, symbol: "triangle-down" } });
    }

    const layout = { paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", margin: { l: 45, r: 15, t: 20, b: 40 }, xaxis: { showgrid: false, color: "#a8b4d6" }, yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6" } };
    Plotly.newPlot("chart", traces, layout, { displayModeBar: false });

    const cyclesData = cycleStats?.cycles ?? [];
    const tableBody = document.querySelector("#cycleTable tbody");
    const recentCycles = cyclesData.filter((cycle) => {
      const d = new Date(cycle.end_date);
      if (state.startDate && d < new Date(state.startDate)) return false;
      if (state.endDate && d > new Date(state.endDate)) return false;
      if (!months) return true;
      const start = new Date(priceDates[priceDates.length - 1]);
      start.setMonth(start.getMonth() - months);
      return d >= start;
    }).slice(-6).reverse();

    if (tableBody) {
      if (recentCycles.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="muted">${t("noCycles")}</td></tr>`;
      } else {
        tableBody.innerHTML = recentCycles.map((cycle) => {
          const dir = cycle.direction === "upswing" ? "up" : "down";
          return `
            <tr>
              <td>${cycle.end_date}</td>
              <td>${cycle.start_date}</td>
              <td><span class="pill ${dir}">${cycle.direction}</span></td>
              <td>${cycle.length}d</td>
              <td>${fmtPct(cycle.amplitude, 1)}</td>
            </tr>
          `;
        }).join("");
      }
    }
  }

  function computeRisk(series, dates) {
    if (!series?.length || !dates?.length) return { dd: null, ulcer: null, worst: null };
    const vals = series.map((p) => p?.equity ?? p);
    let peak = vals[0];
    let maxDd = 0;
    const ddSquares = [];
    vals.forEach((v) => {
      peak = Math.max(peak, v);
      const dd = (v - peak) / peak;
      maxDd = Math.min(maxDd, dd);
      ddSquares.push((dd * 100) ** 2);
    });
    const ulcer = Math.sqrt(ddSquares.reduce((a, b) => a + b, 0) / ddSquares.length);
    // monthly
    const monthMap = new Map();
    vals.forEach((v, i) => {
      const key = `${dates[i].getFullYear()}-${dates[i].getMonth() + 1}`;
      monthMap.set(key, v);
    });
    const keys = Array.from(monthMap.keys()).sort();
    let worst = null;
    for (let i = 1; i < keys.length; i++) {
      const prev = monthMap.get(keys[i - 1]);
      const curr = monthMap.get(keys[i]);
      const r = curr / prev - 1;
      if (worst === null || r < worst) worst = r;
    }
    return { dd: maxDd, ulcer, worst };
  }

  function computeStats(series) {
    if (!series?.length) return { totalReturn: null, maxDrawdown: null, sharpe: null, sortino: null };
    const vals = series.map((p) => p?.equity ?? p);
    if (!vals.length) return { totalReturn: null, maxDrawdown: null, sharpe: null, sortino: null };

    const returns = [];
    for (let i = 1; i < vals.length; i++) {
      if (!vals[i - 1]) continue;
      returns.push(vals[i] / vals[i - 1] - 1);
    }

    const totalReturn = vals[vals.length - 1] / vals[0] - 1;
    let peak = vals[0];
    let maxDd = 0;
    vals.forEach((v) => { peak = Math.max(peak, v); maxDd = Math.min(maxDd, (v - peak) / peak); });

    const mean = returns.reduce((a, b) => a + b, 0) / (returns.length || 1);
    const variance = returns.reduce((a, b) => a + (b - mean) ** 2, 0) / (returns.length || 1);
    const std = Math.sqrt(variance);
    const sharpe = std ? mean / std : 0;
    const downside = returns.filter((r) => r < 0);
    const downsideMean = downside.reduce((a, b) => a + b, 0) / (downside.length || 1);
    const downsideVariance = downside.reduce((a, b) => a + (b - downsideMean) ** 2, 0) / (downside.length || 1);
    const downsideDev = Math.sqrt(downsideVariance);
    const sortino = downsideDev ? mean / downsideDev : 0;

    return {
      totalReturn,
      maxDrawdown: maxDd,
      sharpe,
      sortino,
    };
  }

  function buildBuyHoldSeries(closes) {
    const eq = [{ index: 0, equity: 1 }];
    for (let i = 1; i < closes.length; i++) {
      const ret = closes[i] / closes[i - 1] - 1;
      eq.push({ index: i, equity: eq[i - 1].equity * (1 + ret) });
    }
    return eq;
  }

  function biasClassName(bias) {
    if (!bias) return "neutral";
    if (bias.toLowerCase().includes("bull")) return "up";
    if (bias.toLowerCase().includes("bear")) return "down";
    return "neutral";
  }

  function renderProbabilistic() {
    const data = probabilistic || {};
    const outcomes = data.historical_outcomes || {};
    document.getElementById("scenarioId").textContent = data.scenario_id || "—";
    document.getElementById("probHeadline").textContent = data.message?.headline || t("limitsCopy");
    document.getElementById("probSubtext").textContent = data.message?.subtext || "";
    document.getElementById("probConfidence").textContent = data.confidence !== undefined ? `${Number(data.confidence).toFixed(0)}%` : "—";
    document.getElementById("probOccurrences").textContent = outcomes.occurrences ?? "—";
    document.getElementById("probDisclaimer").textContent = data.disclaimer_level === "HIGH" ? t("limitsCopy") : "";

    document.getElementById("probUp").textContent = fmtPct(outcomes.p_up, 0);
    document.getElementById("probDown").textContent = fmtPct(outcomes.p_down, 0);
    document.getElementById("probMedianReturn").textContent = fmtPct(outcomes.median_return, 2);
    document.getElementById("probSpread").textContent = `${fmtPct(outcomes.p10_return, 1)} → ${fmtPct(outcomes.p90_return, 1)}`;
    document.getElementById("probRange").textContent = `${fmtPct(outcomes.p10_return, 1)} → ${fmtPct(outcomes.p90_return, 1)}`;
    document.getElementById("probMedian").textContent = `${t("medianLabel")}: ${fmtPct(outcomes.median_return, 1)}`;
    const horizon = outcomes.horizon_days || 5;
    const historicalText = outcomes.occurrences
      ? `${fmtPct(outcomes.p_up, 0)} of ${outcomes.occurrences} matches were up after ${horizon}d (median ${fmtPct(outcomes.median_return, 1)}).`
      : t("limitsCopy");
    document.getElementById("historicalSentence").textContent = historicalText;

    const rangeChip = document.getElementById("rangeChip");
    rangeChip.textContent = outcomes.occurrences
      ? `${outcomes.occurrences} cases · ${fmtPct(outcomes.p10_return, 1)} to ${fmtPct(outcomes.p90_return, 1)} after ${horizon}d`
      : t("limitsCopy");

    const evidence = data.evidence || [];
    const evidenceList = document.getElementById("probEvidence");
    if (!evidence.length) {
      evidenceList.innerHTML = `<li>${t("limitsCopy")}</li>`;
    } else {
      evidenceList.innerHTML = evidence.map((e) => `<li>${e.text}</li>`).join("");
    }

    const biasBadge = document.getElementById("biasBadge");
    const bias = data.state?.bias || "NEUTRAL";
    biasBadge.className = `pill ${biasClassName(bias)}`;
    biasBadge.textContent = bias;

    const volBadge = document.getElementById("volBadge");
    const volText = data.state?.volatility || "—";
    volBadge.className = `pill ${volText === "HIGH" ? "up" : volText === "LOW" ? "down" : "neutral"}`;
    volBadge.textContent = volText;
    document.getElementById("probState").textContent = data.state?.regime ? `${data.state.regime} regime` : "";

    const analogies = data.analogs || [];
    const analogyList = document.getElementById("analogyList");
    if (!analogies.length) {
      analogyList.innerHTML = `<div class="muted">${t("limitsCopy")}</div>`;
    } else {
      analogyList.innerHTML = analogies
        .map((a) => {
          return `
            <div class="analogy">
              <div class="muted">${a.start_date} · similarity ${fmt(a.similarity, 2)}</div>
              <div class="v mono">${fmtPct(a.forward_5d, 2)} / ${fmtPct(a.forward_10d, 2)}</div>
              <div class="small muted">${t("medianLabel")}: ${fmtPct(outcomes.median_return, 1)}</div>
            </div>
          `;
        })
        .join("");
    }
  }

  function runBacktest(closes, dates, options) {
    const ma = movingAverage(closes, options.maWindow || 50);
    const bands = bollinger(closes, options.bandWindow || 20, options.bandStd || 2);
    const rsi = computeRsi(closes, options.rsiPeriod || 14);

    const gross = [{ index: 0, equity: 1 }];
    const trades = [];
    let equity = 1;
    let inPosition = false;
    let entryIndex = null;
    let entryEquity = 1;

    for (let i = 1; i < closes.length; i++) {
      if (inPosition) {
        const ret = closes[i] / closes[i - 1] - 1;
        equity *= 1 + ret;
      }

      gross.push({ index: i, equity: Number(equity.toFixed(6)) });

      const maVal = ma[i];
      const rsiVal = rsi[i];
      const lower = bands.lower[i];

      const exitMa = inPosition && maVal !== null && closes[i] < maVal;
      const exitRsi = inPosition && rsiVal !== null && rsiVal >= (options.rsiOverbought || 65);
      if (exitMa || exitRsi) {
        const ret = equity / entryEquity - 1;
        trades.push({
          entry: dates[entryIndex],
          exit: dates[i],
          reason: exitRsi ? "RSI exit" : "MA breakdown",
          return: ret,
          hold: i - entryIndex,
        });
        inPosition = false;
        entryIndex = null;
        entryEquity = equity;
      }

      const entryBand = lower !== null && closes[i] <= lower;
      const entryRsi = rsiVal !== null && rsiVal <= (options.rsiOversold || 35);
      const entryTrend = maVal !== null && closes[i] >= maVal * 0.98;
      if (!inPosition && entryBand && entryRsi && entryTrend) {
        inPosition = true;
        entryIndex = i;
        entryEquity = equity;
      }
    }

    if (inPosition && entryIndex !== null) {
      const ret = equity / entryEquity - 1;
      trades.push({
        entry: dates[entryIndex],
        exit: dates[dates.length - 1],
        reason: "Range timeout",
        return: ret,
        hold: dates.length - 1 - entryIndex,
      });
    }

    const buyHold = buildBuyHoldSeries(closes);

    return {
      gross,
      buyHold,
      trades,
      stats: {
        strategy: computeStats(gross),
        benchmark: computeStats(buyHold),
      },
    };
  }

  function renderEquity(range) {
    const months = range === "3m" ? 3 : range === "1y" ? 12 : null;
    const mask = getRangeMask(months, state.startDate, state.endDate);
    const dates = applyMask(prices.dates, mask, (d) => new Date(d));
    const close = applyMask(prices.close, mask, (v) => v);
    if (!close.length) { document.getElementById("perfChart").textContent = t("perfSeriesUnavailable"); return; }

    const backtest = runBacktest(close, dates, state);
    lastBacktest = backtest;
    const gross = backtest.gross;
    const buyHold = backtest.buyHold;
    const net = applyCosts(gross, state.costBps);
    const grossStats = backtest.stats.strategy;
    const netStats = computeStats(net);
    const benchStats = backtest.stats.benchmark;
    const selectedStats = state.showNet ? netStats : grossStats;

    const chosen = state.showNet ? net : gross;
    const grossReturn = gross.length ? gross[gross.length - 1].equity - 1 : null;
    const netReturn = net.length ? net[net.length - 1].equity - 1 : null;
    const drag = grossReturn !== null && netReturn !== null ? netReturn - grossReturn : null;

    const traces = [
      { x: dates, y: chosen.map((p) => p.equity), mode: "lines", name: state.showNet ? "Strategy (Net)" : "Strategy (Gross)", line: { color: "#4c9cff" } },
      { x: dates, y: buyHold.map((p) => p.equity), mode: "lines", name: "Buy & Hold", line: { color: "#fbbf24", dash: "dot" } },
    ];

    const layout = { paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", margin: { l: 45, r: 15, t: 20, b: 40 }, xaxis: { showgrid: false, color: "#a8b4d6" }, yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6" } };
    Plotly.newPlot("perfChart", traces, layout, { displayModeBar: false });

    const risk = computeRisk(chosen, dates);
    document.getElementById("riskDd").textContent = fmtPct(risk.dd, 2);
    document.getElementById("riskUlcer").textContent = fmt(risk.ulcer, 2);
    document.getElementById("riskWorst").textContent = fmtPct(risk.worst, 2);

    document.getElementById("costsSelected").textContent = `${state.costBps} bps (${fmt(state.costBps / 100, 2)})`;
    document.getElementById("costDragVal").textContent = fmtPct(drag, 2);
    document.getElementById("grossReturnVal").textContent = fmtPct(grossReturn, 2);
    document.getElementById("netReturnVal").textContent = fmtPct(netReturn, 2);

    const perfBody = document.getElementById("perfTableBody");
    const chosenReturn = selectedStats.totalReturn;
    const benchReturn = benchStats.totalReturn;
    const maxDdDisplay = fmtPct(selectedStats.maxDrawdown ?? risk.dd, 2);

    perfBody.innerHTML = `
      <tr><td>${state.showNet ? "Strategy (Net)" : "Strategy (Gross)"}</td><td>${fmtPct(chosenReturn, 2)}</td><td>${maxDdDisplay}</td><td>${fmt(selectedStats.sharpe, 2)}</td><td>${fmt(selectedStats.sortino, 2)}</td></tr>
      <tr><td>${t("buyHoldLabel")}</td><td>${fmtPct(benchReturn, 2)}</td><td>${fmtPct(benchStats.maxDrawdown, 2)}</td><td>${fmt(benchStats.sharpe, 2)}</td><td>${fmt(benchStats.sortino, 2)}</td></tr>
    `;
  }

  function renderTradeLog() {
    const tbody = document.querySelector("#tradeTable tbody");
    const trades = (lastBacktest?.trades ?? []).slice(-8).reverse();
    if (!trades.length) { tbody.innerHTML = `<tr><td colspan="5" class="muted">${t("noCycles")}</td></tr>`; return; }
    const fmtDate = (d) => {
      if (!d) return "—";
      if (d instanceof Date) return d.toISOString().slice(0, 10);
      return String(d).slice(0, 10);
    };

    tbody.innerHTML = trades.map((trade) => {
      return `<tr>
        <td>${fmtDate(trade.entry)}</td>
        <td>${fmtDate(trade.exit)}</td>
        <td>${trade.reason}</td>
        <td>${fmtPct(trade.return, 2)}</td>
        <td>${trade.hold}d</td>
      </tr>`;
    }).join("");
  }

  function renderSummary() {
    const updatedText = probabilistic.asof || anomalies.asof || anomalies.updated_at || meta?.last_updated_utc || "—";
    document.getElementById("updated").textContent = `${t("updatedPrefix")}: ${updatedText}`;
    document.getElementById("anomalyUpdated").textContent = `${t("updatedPrefix")}: ${updatedText}`;
    document.getElementById("anomalyScore").textContent = fmt(anomalies.anomaly_score, 0);
    document.getElementById("adxVal").textContent = fmt(anomalies.regime?.adx, 1);
    document.getElementById("atrVal").textContent = fmt(anomalies.regime?.atr, 4);
    document.getElementById("alertCount").textContent = anomalies.alerts?.length ?? 0;

    const trendLabel = anomalies.regime?.trend_state ?? "—";
    document.getElementById("trendTag").textContent = trendLabel;
    document.getElementById("trendNote").textContent = anomalies.regime?.ma50 && anomalies.regime?.ma200
      ? `${t("maLabel")}: ${fmt(anomalies.regime.ma50, 2)} / ${fmt(anomalies.regime.ma200, 2)}`
      : "—";

    const volLabel = anomalies.regime?.vol_state ?? "—";
    document.getElementById("volTag").textContent = `Vol ${volLabel}`;
    document.getElementById("volNote").textContent = anomalies.regime?.vol_state === "HIGH" ? "ATR elevated vs history" : anomalies.regime?.vol_state === "LOW" ? "ATR muted vs history" : "Within normal range";

    const lastClose = anomalies.price?.last_close ?? prices.close?.[prices.close.length - 1];
    document.getElementById("lastClose").textContent = fmt(lastClose, 2);
    document.getElementById("mas").textContent = `${t("maLabel")}: ${fmt(anomalies.price?.ma20,2)} / ${fmt(anomalies.price?.ma50,2)} / ${fmt(anomalies.price?.ma200,2)}`;
    const mom = prices.close?.length > 22 ? (prices.close[prices.close.length - 1] / prices.close[prices.close.length - 22] - 1) * 100 : null;
    document.getElementById("mom").textContent = fmt(mom, 2);

    const alerts = anomalies.alerts ?? [];
    document.getElementById("topAlert").textContent = alerts[0]?.why ?? t("noAlerts");
    const container = document.getElementById("alertsContainer");
    if (!alerts.length) {
      container.innerHTML = `<div class="muted">${t("noAlerts")}</div>`;
    } else {
      container.innerHTML = alerts.map((alert) => {
        const sev = alert.severity?.toLowerCase?.() || "info";
        return `
          <div class="alert-card">
            <div class="title">${alert.id} <span class="badge-inline sev-${sev}">${alert.severity}</span> <span class="badge-inline">${alert.direction}</span></div>
            <div class="muted">${alert.why}</div>
            <div class="muted small">z=${fmt(alert.evidence?.z,2)} · ${alert.historical_context?.occurrences || 0} past cases</div>
          </div>
        `;
      }).join("");
    }

    document.getElementById("perfSummaryUpdated").textContent = perfSummary.updated_at || "—";
    document.getElementById("perfSummaryUpdated2").textContent = perfSummary.updated_at || "—";
    const algoScore = perfSummary.algo_score || {};
    const algoComposite = algoScore.composite ?? algoScore.score ?? null;
    document.getElementById("algoScore").textContent = fmt(algoComposite, 0);
    const hit = fmtPct(algoScore.hit_rate ?? perfSummary.hit_rate, 0);
    const sharpe = fmt(algoScore.sharpe_ratio, 2);
    const cycle = fmtPct(algoScore.cycle_capture_rate, 0);
    document.getElementById("algoScoreMeta").textContent = `${t("hitRateLabel")}: ${hit} · ${t("sharpeLabel")}: ${sharpe} · ${t("cycleCaptureLabel")}: ${cycle}`;
    document.getElementById("hitRate").textContent = fmtPct(perfSummary.hit_rate, 0);
    document.getElementById("avgReturn5d").textContent = fmtPct(perfSummary.avg_return_5d, 2);
    document.getElementById("avgReturn10d").textContent = fmtPct(perfSummary.avg_return_10d, 2);
    document.getElementById("maxDrawdown").textContent = fmtPct(perfSummary.max_drawdown, 2);

    document.getElementById("decompUpdated").textContent = decomposition.updated_at || "—";
    document.getElementById("decompPeriod").textContent = decomposition.period ?? "—";
  }

  function renderDecomposition(range) {
    const months = range === "3m" ? 3 : range === "1y" ? 12 : null;
    const mask = getRangeMask(months, state.startDate, state.endDate);
    const dates = applyMask(prices.dates, mask);
    const trend = applyMask(decomposition.trend ?? [], mask);
    const seasonal = applyMask(decomposition.seasonal ?? [], mask);
    const residual = applyMask(decomposition.residual ?? [], mask);

    if (!trend.length) {
      document.getElementById("trendChart").textContent = t("decompUnavailable");
      document.getElementById("seasonalChart").textContent = t("decompUnavailable");
      return;
    }

    const layout = { paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", margin: { l: 45, r: 15, t: 10, b: 30 }, xaxis: { showgrid: false, color: "#a8b4d6" }, yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6" } };
    Plotly.newPlot("trendChart", [{ x: dates, y: trend, mode: "lines", name: t("trendTitle"), line: { color: "#4c9cff" } }], layout, { displayModeBar: false });
    Plotly.newPlot("seasonalChart", [
      { x: dates, y: seasonal, mode: "lines", name: t("seasonalTitle"), line: { color: "#fbbf24" } },
      { x: dates, y: residual, mode: "lines", name: "Residual", line: { color: "#a855f7", dash: "dot" } },
    ], layout, { displayModeBar: false });
  }

  function renderAll() {
    applyLanguage();
    renderEventContext(eventContext);
    renderContextPanel(currentContext, conditionalContextStats);
    renderProbabilistic();
    renderMeta();
    renderSummary();
    renderDeviationPanel();
    renderBandStats();
    renderHeatmap();
    renderPrice(state.range);
    renderEquity(state.range);
    renderTradeLog();
    renderDecomposition(state.range);
  }

  renderAll();
  attachHeatmapControls();

  document.querySelectorAll('.btn[data-range]').forEach((btn) => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.btn[data-range]').forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      state.range = btn.dataset.range;
      renderAll();
    });
  });

  document.getElementById("toggleMa").addEventListener("change", (e) => { state.showMa = e.target.checked; renderPrice(state.range); });
  document.getElementById("toggleBoll").addEventListener("change", (e) => { state.showBoll = e.target.checked; renderPrice(state.range); });
  document.getElementById("toggleCycles").addEventListener("change", (e) => { state.showCycles = e.target.checked; renderPrice(state.range); });

  document.getElementById("langToggle").addEventListener("click", () => { state.lang = state.lang === "he" ? "en" : "he"; localStorage.setItem("lang", state.lang); renderAll(); });

  const advancedToggle = document.getElementById("advancedToggle");
  advancedToggle.addEventListener("click", () => {
    const panel = document.getElementById("advancedPanel");
    const visible = panel.style.display !== "none";
    panel.style.display = visible ? "none" : "block";
    advancedToggle.textContent = visible ? t("openSettings") : "Close";
  });

  document.getElementById("toggleSettings").addEventListener("click", () => {
    const panel = document.getElementById("settingsPanel");
    const visible = panel.style.display === "grid";
    panel.style.display = visible ? "none" : "grid";
    document.getElementById("toggleSettings").textContent = visible ? t("openSettings") : "Close";
  });

  const startInput = document.getElementById("startDate");
  const endInput = document.getElementById("endDate");
  startInput.value = state.startDate.slice(0, 10);
  endInput.value = state.endDate.slice(0, 10);

  const syncDates = () => {
    const startDate = new Date(state.startDate);
    const endDate = new Date(state.endDate);
    if (startDate > endDate) { state.endDate = state.startDate; endInput.value = state.endDate.slice(0, 10); }
  };

  startInput.addEventListener("change", (e) => { state.startDate = e.target.value || state.startDate; syncDates(); renderAll(); });
  endInput.addEventListener("change", (e) => { state.endDate = e.target.value || state.endDate; syncDates(); renderAll(); });

  document.getElementById("costsInput").addEventListener("input", (e) => { state.costBps = Number(e.target.value) || 0; renderEquity(state.range); });
  document.getElementById("maWindowInput").addEventListener("input", (e) => { state.maWindow = Number(e.target.value) || state.maWindow; renderEquity(state.range); renderTradeLog(); });
  document.getElementById("rsiPeriodInput").addEventListener("input", (e) => { state.rsiPeriod = Number(e.target.value) || state.rsiPeriod; renderEquity(state.range); renderTradeLog(); });
  document.getElementById("rsiOversoldInput").addEventListener("input", (e) => { state.rsiOversold = Number(e.target.value) || state.rsiOversold; renderEquity(state.range); renderTradeLog(); });
  document.getElementById("rsiOverboughtInput").addEventListener("input", (e) => { state.rsiOverbought = Number(e.target.value) || state.rsiOverbought; renderEquity(state.range); renderTradeLog(); });
  document.getElementById("bandWindowInput").addEventListener("input", (e) => { state.bandWindow = Number(e.target.value) || state.bandWindow; renderEquity(state.range); renderTradeLog(); });
  document.getElementById("bandStdInput").addEventListener("input", (e) => { state.bandStd = Number(e.target.value) || state.bandStd; renderEquity(state.range); renderTradeLog(); });
  document.querySelectorAll('input[name="equityMode"]').forEach((r) => {
    r.addEventListener('change', (e) => { state.showNet = e.target.value === 'net'; renderEquity(state.range); });
  });
  document.querySelectorAll('input[name="pnltoggle"]').forEach((r) => {
    r.addEventListener('change', (e) => { state.showNet = e.target.value === 'net'; document.querySelector('input[name="equityMode"][value="'+(state.showNet?'net':'gross')+'"]').checked = true; renderEquity(state.range); });
  });
})();
</script>
</body>
</html>
