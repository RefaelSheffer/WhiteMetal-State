<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SLV Monitor</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background: #0b0f17; color: #e8eefc; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #111a2b; border: 1px solid #1e2a45; border-radius: 14px; padding: 16px; }
    .big { font-size: 28px; font-weight: 800; }
    .muted { color: #a8b4d6; }
    .alert { margin-top: 10px; background: rgba(255, 159, 64, 0.12); border: 1px solid #ff9f40; color: #ffd7a2; padding: 10px 12px; border-radius: 10px; line-height: 1.5; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .kpis.four { grid-template-columns: repeat(4, 1fr); }
    .kpi { background:#0d1424; border:1px solid #1e2a45; border-radius:12px; padding:10px; }
    .kpi .v { font-size: 18px; font-weight: 700; margin-top: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .cycle-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    .cycle-table th, .cycle-table td { padding: 6px 8px; text-align: right; border-bottom: 1px solid #1e2a45; }
    .cycle-table th { color: #a8b4d6; font-weight: 600; }
    .cycle-table td { color: #e8eefc; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #1e2a45; }
    .pill.up { background: rgba(34, 197, 94, 0.12); color: #22c55e; }
    .pill.down { background: rgba(244, 63, 94, 0.12); color: #f43f5e; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin: 12px 0 4px; }
    .btn { background: #0d1424; color: #e8eefc; border: 1px solid #1e2a45; border-radius: 10px; padding: 6px 10px; cursor: pointer; }
    .btn.active { background: #1f2d4a; border-color: #4c9cff; }
    .toggle { display: flex; gap: 6px; align-items: center; padding: 6px 10px; background: #0d1424; border: 1px solid #1e2a45; border-radius: 10px; }
    .toggle input { accent-color: #4c9cff; }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    a { color:#8bb2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="big">SLV Monitor</div>
      <div class="muted">דשבורד סטטי ב-GitHub Pages + “מוח” שרץ ב-GitHub Actions ומעדכן JSON.</div>
      <div class="muted mono" id="updated">Loading…</div>
      <div class="alert">
        המלצות המערכת הן תוצאה של עיבוד סטטיסטי ואינן מהוות ייעוץ או הנחיה לביצוע פעולה מיידית. מומלץ לשלב את האיתותים עם
        גורמים נוספים כמו חדשות מאקרו, מדיניות מוניטרית ושיקולים אישיים אחרים.
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="big" id="action">—</div>
        <div class="muted">Confidence: <span class="mono" id="confidence">—</span></div>

        <div class="kpis">
          <div class="kpi">
            <div class="muted">Score Total</div>
            <div class="v mono" id="scoreTotal">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Price Score</div>
            <div class="v mono" id="scorePrice">—</div>
          </div>
          <div class="kpi">
            <div class="muted">COT Score</div>
            <div class="v mono" id="scoreCOT">—</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="muted">Latest Close: <span class="mono" id="lastClose">—</span></div>
        <div class="muted">MA20/50/200: <span class="mono" id="mas">—</span></div>
        <div class="muted">1M Mom%: <span class="mono" id="mom">—</span></div>

        <div style="height:12px"></div>
        <div class="muted">COT (Silver): <span class="mono" id="cotLine">—</span></div>
        <div class="muted">EDGAR: <span class="mono" id="edgarLine">—</span></div>
      </div>

      <div class="card">
        <div class="big">Price</div>
        <div class="controls">
          <div class="muted">טווח זמן:</div>
          <button class="btn active" data-range="3m">3M</button>
          <button class="btn" data-range="1y">1Y</button>
          <button class="btn" data-range="all">All</button>
          <span style="flex:1"></span>
          <label class="toggle"><input type="checkbox" id="toggleRsi" checked />RSI</label>
          <label class="toggle"><input type="checkbox" id="toggleStd" checked />StdDev</label>
          <label class="toggle"><input type="checkbox" id="toggleDecomp" checked />Decomposition</label>
        </div>
        <div id="chart" style="height:420px;"></div>
        <div class="muted" style="margin-top:8px;">מחזורי Peaks/Troughs אחרונים</div>
        <table class="cycle-table" id="cycleTable">
          <thead>
            <tr>
              <th>תאריך סיום</th>
              <th>תאריך התחלה</th>
              <th>כיוון</th>
              <th>אורך</th>
              <th>אמפליטודה</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="big">ציון ביצועים כולל</div>
        <div class="muted">עודכן: <span class="mono" id="perfSummaryUpdated">—</span></div>

        <div class="kpis four">
          <div class="kpi">
            <div class="muted">Hit Rate</div>
            <div class="v mono" id="hitRate">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Avg Return 5d</div>
            <div class="v mono" id="avgReturn5d">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Avg Return 10d</div>
            <div class="v mono" id="avgReturn10d">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Max Drawdown</div>
            <div class="v mono" id="maxDrawdown">—</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="big">Equity vs Benchmark (SLV)</div>
        <div id="perfChart" style="height:320px;"></div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card" id="perfCard">
        <div class="big">Performance</div>
        <div class="muted" id="rsiRow">RSI (14): <span class="mono" id="rsiValue">—</span></div>
        <div class="muted" id="stdRow">Rolling StdDev (20): <span class="mono" id="stddevValue">—</span></div>
        <div class="muted">Perf Updated: <span class="mono" id="perfUpdated">—</span></div>
      </div>

      <div class="card" id="decompCard">
        <div class="big">Decomposition</div>
        <div class="muted">Updated: <span class="mono" id="decompUpdated">—</span></div>
        <div class="muted">Period: <span class="mono" id="decompPeriod">—</span></div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card" id="trendCardWrap">
        <div class="big">Trend</div>
        <div id="trendChart" style="height:320px;"></div>
      </div>

      <div class="card" id="seasonalCardWrap">
        <div class="big">Seasonal / Residual</div>
        <div id="seasonalChart" style="height:320px;"></div>
      </div>
    </div>
  </div>

<script>
async function getJson(path) {
  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) throw new Error(`Failed ${path}: ${r.status}`);
  return await r.json();
}

function fmt(x, d=2) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return Number(x).toFixed(d);
}

function fmtPct(x, d=1) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return `${(Number(x) * 100).toFixed(d)}%`;
}

(async () => {
  const [prices, signal, cot, edgar, rsiPerf, stddevPerf, decomposition, perfSummary, equityCurve, cycleStats] = await Promise.all([
    getJson("./data/slv_prices.json"),
    getJson("./data/signal_latest.json"),
    getJson("./data/cot_silver.json"),
    getJson("./data/edgar_latest.json"),
    getJson("./public/data/perf/rsi.json"),
    getJson("./public/data/perf/stddev.json"),
    getJson("./public/data/perf/decomposition.json"),
    getJson("./public/data/perf/summary.json"),
    getJson("./public/data/perf/equity_curve.json"),
    getJson("./public/data/events/cycle_stats.json"),
  ]);

  const state = { range: "3m", showRsi: true, showStd: true, showDecomp: true };
  const priceDates = prices.dates.map((d) => new Date(d));

  function getRangeMask(months) {
    if (!months) return priceDates.map((_, i) => i);
    const lastDate = priceDates[priceDates.length - 1];
    const start = new Date(lastDate);
    start.setMonth(start.getMonth() - months);
    const mask = [];
    priceDates.forEach((d, i) => {
      if (d >= start) mask.push(i);
    });
    return mask;
  }

  function applyMask(arr, mask, accessor) {
    if (!Array.isArray(arr)) return [];
    return mask.map((i) => (accessor ? accessor(arr[i], i) : arr[i])).filter((v) => v !== undefined);
  }

  function renderPrice(range) {
    const months = range === "3m" ? 3 : range === "1y" ? 12 : null;
    const mask = getRangeMask(months);
    const rangeDates = applyMask(prices.dates, mask);
    const rangeClose = applyMask(prices.close, mask);

    const turningPoints = (cycleStats?.turning_points ?? []).filter((p) => {
      if (!months) return true;
      const d = new Date(p.date);
      const start = new Date(priceDates[priceDates.length - 1]);
      start.setMonth(start.getMonth() - months);
      return d >= start;
    });

    const trace = { x: rangeDates, y: rangeClose, type: "scatter", mode: "lines", name: "SLV Close" };
    const peakPoints = turningPoints.filter((p) => p.kind === "peak");
    const troughPoints = turningPoints.filter((p) => p.kind === "trough");
    const peakTrace = { x: peakPoints.map((p) => p.date), y: peakPoints.map((p) => p.close), mode: "markers", type: "scatter", name: "Peak", marker: { color: "#f43f5e", size: 8, symbol: "triangle-up" } };
    const troughTrace = { x: troughPoints.map((p) => p.date), y: troughPoints.map((p) => p.close), mode: "markers", type: "scatter", name: "Trough", marker: { color: "#22c55e", size: 8, symbol: "triangle-down" } };

    const layout = {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      margin: { l: 45, r: 15, t: 20, b: 40 },
      xaxis: { showgrid: false, color: "#a8b4d6" },
      yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6" },
    };

    const series = turningPoints.length ? [trace, peakTrace, troughTrace] : [trace];
    Plotly.newPlot("chart", series, layout, { displayModeBar: false });

    const cyclesData = cycleStats?.cycles ?? [];
    const tableBody = document.querySelector("#cycleTable tbody");
    const recentCycles = cyclesData
      .filter((cycle) => {
        if (!months) return true;
        const d = new Date(cycle.end_date);
        const start = new Date(priceDates[priceDates.length - 1]);
        start.setMonth(start.getMonth() - months);
        return d >= start;
      })
      .slice(-6)
      .reverse();

    if (tableBody) {
      if (recentCycles.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="muted">No cycles detected yet.</td></tr>';
      } else {
        tableBody.innerHTML = recentCycles
          .map((cycle) => {
            const amp = fmtPct(cycle.amplitude, 1);
            const len = cycle.length ?? 0;
            const dir = cycle.direction === "upswing" ? "up" : "down";
            return `
              <tr>
                <td>${cycle.end_date}</td>
                <td>${cycle.start_date}</td>
                <td><span class="pill ${dir}">${cycle.direction}</span></td>
                <td>${len}d</td>
                <td>${amp}</td>
              </tr>
            `;
          })
          .join("");
      }
    }
  }

  function renderEquity(range) {
    const months = range === "3m" ? 3 : range === "1y" ? 12 : null;
    const equitySeries = equityCurve.equity_curve ?? [];
    const eqValues = equitySeries.map((p) => p.equity);
    if (!eqValues.length) {
      document.getElementById("perfChart").textContent = "Performance series unavailable.";
      return;
    }

    const eqBase = eqValues[0] || 1;
    const eqNormalized = eqValues.map((v) => v / eqBase);
    const sliceLen = eqNormalized.length;
    const benchPrices = prices.close.slice(-sliceLen);
    const benchDates = prices.dates.slice(-sliceLen);

    if (benchPrices.length !== sliceLen || benchDates.length !== sliceLen) {
      document.getElementById("perfChart").textContent = "Benchmark window unavailable.";
      return;
    }

    const benchBase = benchPrices[0] || 1;
    const benchNormalized = benchPrices.map((p) => p / benchBase);

    const lastBenchDate = new Date(benchDates[benchDates.length - 1]);
    const startDate = months ? (() => { const s = new Date(lastBenchDate); s.setMonth(s.getMonth() - months); return s; })() : null;

    const filteredDates = [];
    const filteredEq = [];
    const filteredBench = [];
    benchDates.forEach((d, idx) => {
      const dateObj = new Date(d);
      if (!startDate || dateObj >= startDate) {
        filteredDates.push(d);
        filteredEq.push(eqNormalized[idx]);
        filteredBench.push(benchNormalized[idx]);
      }
    });

    const layout = {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      margin: { l: 45, r: 15, t: 20, b: 40 },
      xaxis: { showgrid: false, color: "#a8b4d6" },
      yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6", title: "Normalized Performance" },
    };

    const equityTrace = { x: filteredDates, y: filteredEq, type: "scatter", mode: "lines", name: "Algo Equity", line: { color: "#60a5fa" } };
    const benchTrace = { x: filteredDates, y: filteredBench, type: "scatter", mode: "lines", name: "SLV Benchmark", line: { color: "#22c55e" } };

    Plotly.newPlot("perfChart", [equityTrace, benchTrace], layout, { displayModeBar: false });
  }

  function renderDecomposition(range) {
    if (!state.showDecomp) {
      document.getElementById("decompCard").style.display = "none";
      document.getElementById("trendCardWrap").style.display = "none";
      document.getElementById("seasonalCardWrap").style.display = "none";
      return;
    }

    document.getElementById("decompCard").style.display = "";
    document.getElementById("trendCardWrap").style.display = "";
    document.getElementById("seasonalCardWrap").style.display = "";

    const months = range === "3m" ? 3 : range === "1y" ? 12 : null;
    const mask = getRangeMask(months);
    const rangeDates = applyMask(prices.dates, mask);
    const trendValues = applyMask(decomposition.trend, mask, (p) => p?.trend);
    const seasonalValues = applyMask(decomposition.seasonal, mask, (p) => p?.seasonal);
    const residValues = applyMask(decomposition.resid, mask, (p) => p?.resid);

    const layout = {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      margin: { l: 45, r: 15, t: 20, b: 40 },
      xaxis: { showgrid: false, color: "#a8b4d6" },
      yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6" },
    };

    if (trendValues.length) {
      Plotly.newPlot("trendChart", [{ x: rangeDates, y: trendValues, type: "scatter", mode: "lines", name: "Trend", line: { color: "#4c9cff" } }], { ...layout, yaxis: { ...layout.yaxis, title: "Trend" } }, { displayModeBar: false });
    } else {
      document.getElementById("trendChart").textContent = "Decomposition unavailable.";
    }

    if (seasonalValues.length || residValues.length) {
      const seasonalTrace = { x: rangeDates, y: seasonalValues, type: "scatter", mode: "lines", name: "Seasonal", line: { color: "#22c55e" } };
      const residTrace = { x: rangeDates, y: residValues, type: "scatter", mode: "lines", name: "Residual", line: { color: "#fbbf24" } };
      Plotly.newPlot("seasonalChart", [seasonalTrace, residTrace], { ...layout, yaxis: { ...layout.yaxis, title: "Seasonal / Residual" } }, { displayModeBar: false });
    } else {
      document.getElementById("seasonalChart").textContent = "Decomposition unavailable.";
    }
  }

  function renderIndicators(range) {
    document.getElementById("rsiRow").style.display = state.showRsi ? "" : "none";
    document.getElementById("stdRow").style.display = state.showStd ? "" : "none";

    const months = range === "3m" ? 3 : range === "1y" ? 12 : null;
    const lastPriceDate = priceDates[priceDates.length - 1];
    const start = months ? (() => { const s = new Date(lastPriceDate); s.setMonth(s.getMonth() - months); return s; })() : null;

    function latestInRange(series) {
      if (!Array.isArray(series) || series.length === 0) return null;
      const filtered = series.filter((p) => {
        if (!start) return true;
        const d = new Date(p.date);
        return d >= start;
      });
      return filtered[filtered.length - 1] || null;
    }

    const latestRsi = state.showRsi ? latestInRange(rsiPerf.rsi) : null;
    const latestStd = state.showStd ? latestInRange(stddevPerf.stddev) : null;

    document.getElementById("rsiValue").textContent = fmt(latestRsi?.rsi, 2);
    document.getElementById("stddevValue").textContent = fmt(latestStd?.stddev, 4);
    document.getElementById("perfUpdated").textContent = rsiPerf.updated_at || "—";
  }

  function renderAll() {
    renderPrice(state.range);
    renderEquity(state.range);
    renderDecomposition(state.range);
    renderIndicators(state.range);
  }

  document.getElementById("updated").textContent =
    `Updated (UTC): ${signal.updated_at_utc}`;

  document.getElementById("action").textContent = signal.action;
  document.getElementById("confidence").textContent = signal.confidence;

  document.getElementById("scoreTotal").textContent = fmt(signal.score_total, 0);
  document.getElementById("scorePrice").textContent = fmt(signal.breakdown.score_price, 0);
  document.getElementById("scoreCOT").textContent = fmt(signal.breakdown.score_cot, 0);

  document.getElementById("lastClose").textContent = fmt(signal.price.last_close, 2);
  document.getElementById("mas").textContent =
    `${fmt(signal.price.ma20,2)} / ${fmt(signal.price.ma50,2)} / ${fmt(signal.price.ma200,2)}`;
  document.getElementById("mom").textContent = fmt(signal.price.mom_1m_pct, 2);

  if (cot.cot_available) {
    document.getElementById("cotLine").textContent =
      `Report ${cot.cot_report_date}, nc_net=${fmt(cot.nc_net,0)}, Δ4w=${fmt(cot.nc_net_delta_4w,0)}, pct=${fmt(cot.nc_net_percentile,1)}`;
  } else {
    document.getElementById("cotLine").textContent = "COT unavailable (yet).";
  }

  if (edgar.edgar_available && edgar.latest_filing) {
    document.getElementById("edgarLine").textContent =
      `${edgar.latest_filing.form} @ ${edgar.latest_filing.filingDate} (days_ago=${edgar.latest_filing.days_ago})`;
  } else if (edgar.edgar_available) {
    document.getElementById("edgarLine").textContent = "No latest filing found.";
  } else {
    document.getElementById("edgarLine").textContent = "EDGAR unavailable (yet).";
  }

  document.getElementById("perfSummaryUpdated").textContent = perfSummary.updated_at || "—";
  document.getElementById("hitRate").textContent = fmtPct(perfSummary.hit_rate, 0);
  document.getElementById("avgReturn5d").textContent = fmtPct(perfSummary.avg_return_5d, 2);
  document.getElementById("avgReturn10d").textContent = fmtPct(perfSummary.avg_return_10d, 2);
  document.getElementById("maxDrawdown").textContent = fmtPct(perfSummary.max_drawdown, 2);

  document.getElementById("decompUpdated").textContent = decomposition.updated_at || "—";
  document.getElementById("decompPeriod").textContent = decomposition.period ?? "—";

  renderAll();

  document.querySelectorAll('.btn[data-range]').forEach((btn) => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.btn[data-range]').forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      state.range = btn.dataset.range;
      renderAll();
    });
  });

  document.getElementById("toggleRsi").addEventListener("change", (e) => {
    state.showRsi = e.target.checked;
    renderIndicators(state.range);
  });

  document.getElementById("toggleStd").addEventListener("change", (e) => {
    state.showStd = e.target.checked;
    renderIndicators(state.range);
  });

  document.getElementById("toggleDecomp").addEventListener("change", (e) => {
    state.showDecomp = e.target.checked;
    renderDecomposition(state.range);
  });
})();
</script>
</body>
</html>
