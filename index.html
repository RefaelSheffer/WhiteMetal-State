<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SLV Monitor</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background: #0b0f17; color: #e8eefc; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: #111a2b; border: 1px solid #1e2a45; border-radius: 14px; padding: 16px; }
    .big { font-size: 28px; font-weight: 800; }
    .muted { color: #a8b4d6; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .kpi { background:#0d1424; border:1px solid #1e2a45; border-radius:12px; padding:10px; }
    .kpi .v { font-size: 18px; font-weight: 700; margin-top: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    a { color:#8bb2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="big">SLV Monitor</div>
      <div class="muted">דשבורד סטטי ב-GitHub Pages + “מוח” שרץ ב-GitHub Actions ומעדכן JSON.</div>
      <div class="muted mono" id="updated">Loading…</div>
    </div>

    <div style="height:16px"></div>

    <div class="row">
      <div class="card">
        <div class="big" id="action">—</div>
        <div class="muted">Confidence: <span class="mono" id="confidence">—</span></div>

        <div class="kpis">
          <div class="kpi">
            <div class="muted">Score Total</div>
            <div class="v mono" id="scoreTotal">—</div>
          </div>
          <div class="kpi">
            <div class="muted">Price Score</div>
            <div class="v mono" id="scorePrice">—</div>
          </div>
          <div class="kpi">
            <div class="muted">COT Score</div>
            <div class="v mono" id="scoreCOT">—</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="muted">Latest Close: <span class="mono" id="lastClose">—</span></div>
        <div class="muted">MA20/50/200: <span class="mono" id="mas">—</span></div>
        <div class="muted">1M Mom%: <span class="mono" id="mom">—</span></div>

        <div style="height:12px"></div>
        <div class="muted">COT (Silver): <span class="mono" id="cotLine">—</span></div>
        <div class="muted">EDGAR: <span class="mono" id="edgarLine">—</span></div>
      </div>

      <div class="card">
        <div class="big">Price</div>
        <div id="chart" style="height:420px;"></div>
      </div>
    </div>

    <div style="height:16px"></div>
    <div class="card muted">
      Not financial advice. For research only.
    </div>
  </div>

<script>
async function getJson(path) {
  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) throw new Error(`Failed ${path}: ${r.status}`);
  return await r.json();
}

function fmt(x, d=2) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  return Number(x).toFixed(d);
}

(async () => {
  const [prices, signal, cot, edgar] = await Promise.all([
    getJson("./data/slv_prices.json"),
    getJson("./data/signal_latest.json"),
    getJson("./data/cot_silver.json"),
    getJson("./data/edgar_latest.json"),
  ]);

  document.getElementById("updated").textContent =
    `Updated (UTC): ${signal.updated_at_utc}`;

  document.getElementById("action").textContent = signal.action;
  document.getElementById("confidence").textContent = signal.confidence;

  document.getElementById("scoreTotal").textContent = fmt(signal.score_total, 0);
  document.getElementById("scorePrice").textContent = fmt(signal.breakdown.score_price, 0);
  document.getElementById("scoreCOT").textContent = fmt(signal.breakdown.score_cot, 0);

  document.getElementById("lastClose").textContent = fmt(signal.price.last_close, 2);
  document.getElementById("mas").textContent =
    `${fmt(signal.price.ma20,2)} / ${fmt(signal.price.ma50,2)} / ${fmt(signal.price.ma200,2)}`;
  document.getElementById("mom").textContent = fmt(signal.price.mom_1m_pct, 2);

  if (cot.cot_available) {
    document.getElementById("cotLine").textContent =
      `Report ${cot.cot_report_date}, nc_net=${fmt(cot.nc_net,0)}, Δ4w=${fmt(cot.nc_net_delta_4w,0)}, pct=${fmt(cot.nc_net_percentile,1)}`;
  } else {
    document.getElementById("cotLine").textContent = "COT unavailable (yet).";
  }

  if (edgar.edgar_available && edgar.latest_filing) {
    document.getElementById("edgarLine").textContent =
      `${edgar.latest_filing.form} @ ${edgar.latest_filing.filingDate} (days_ago=${edgar.latest_filing.days_ago})`;
  } else if (edgar.edgar_available) {
    document.getElementById("edgarLine").textContent = "No latest filing found.";
  } else {
    document.getElementById("edgarLine").textContent = "EDGAR unavailable (yet).";
  }

  // Chart
  const trace = {
    x: prices.dates,
    y: prices.close,
    type: "scatter",
    mode: "lines",
    name: "SLV Close",
  };

  const layout = {
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    margin: { l: 45, r: 15, t: 20, b: 40 },
    xaxis: { showgrid: false, color: "#a8b4d6" },
    yaxis: { showgrid: true, gridcolor: "#1e2a45", color: "#a8b4d6" },
  };

  Plotly.newPlot("chart", [trace], layout, {displayModeBar: false});
})();
</script>
</body>
</html>
